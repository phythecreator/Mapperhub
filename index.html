<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geomarkr</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    /* Scrollbar fininha para sidebar */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #818cf8; /* indigo-400 */
      border-radius: 10px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden select-none">

<div id="root" class="h-full"></div>

<script type="text/babel">

const {useState, useEffect, useMemo, useRef} = React;
const {geoMercator, geoPath} = d3.geo;
const {feature} = topojson;

// --- Constants ---

const COLORS = [
  "#ff595e","#ffca3a","#8ac926","#1982c4","#6a4c93",
  "#ff6f91","#ff9671","#ffc75f","#f9f871","#3f37c9",
  "#0ead69","#8338ec","#3a86ff","#fb5607","#ff006e",
  "#8338ec","#3a86ff","#ffbe0b","#fb5607","#ff006e",
  "#118ab2","#06d6a0","#ffd166","#ef476f","#073b4c",
  "#00bfa6","#9e0059","#9a031e","#5f0f40","#0f4c5c",
  "#f94144","#f3722c","#f8961e","#f9844a","#f9c74f",
  "#90be6d","#43aa8b","#577590","#277da1","#4d908e",
  "#b5179e","#720026","#ce4257","#e0aaff","#b29dd9",
  "#d62828","#f77f00","#fcbf49","#eae2b7","#003049",
  "#007f5f","#2b9348","#55a630","#80b918","#aacc00",
  "#bbd0ff","#ffd6e8","#ffa4a4","#ff616f","#ff9a8b",
  "#2d3142","#4f5d75","#bfc0c0","#ef8354","#bfbfbf",
];

// URL topojson world map (Natural Earth 110m simplified)
const WORLD_TOPOJSON_URL = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

// --- Components ---

// Tooltip componente
function Tooltip() {
  return (
    <div
      ref={tooltipRef}
      style={{
        position: "absolute",
        padding: "6px 12px",
        backgroundColor: "rgba(0,0,0,0.75)",
        borderRadius: "4px",
        pointerEvents: "none",
        color: "white",
        fontSize: "0.85rem",
        display: "none",
        zIndex: 1000,
      }}
      id="tooltip"
    />
  );
}
const tooltipRef = React.createRef();

function Intro({onCreateMap, onCreateAccount}) {
  return (
    <div className="flex flex-col justify-center items-center h-full px-6 text-center max-w-3xl mx-auto">
      <img
        src="https://raw.githubusercontent.com/OpenAI/chatgpt-assets/main/geomarkr-logo.png"
        alt="Geomarkr Logo"
        className="w-32 mb-6"
      />
      <h1 className="text-5xl font-extrabold text-indigo-400 mb-6 tracking-tight">Create beautiful, detailed maps in seconds</h1>
      <p className="text-gray-300 mb-12 max-w-lg mx-auto text-lg leading-relaxed">
        Customize every country and region with over 70 colors, download your creation in high quality PNG, and save your work securely with your own account.
      </p>
      <div className="flex gap-6">
        <button
          onClick={onCreateMap}
          className="bg-indigo-600 hover:bg-indigo-700 transition rounded-lg px-10 py-4 font-semibold text-lg shadow-lg"
        >
          Create Map
        </button>
        <button
          onClick={onCreateAccount}
          className="bg-gray-800 hover:bg-gray-700 transition rounded-lg px-10 py-4 font-semibold text-lg shadow-lg border border-gray-700"
        >
          Create Account
        </button>
      </div>
    </div>
  );
}

function LoginForm({ onLogin, onSwitchToRegister }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error,setError] = useState("");

  function handleSubmit(e) {
    e.preventDefault();
    if (!username.trim() || !password) {
      setError("Please enter username and password");
      return;
    }
    const users = JSON.parse(localStorage.getItem("geomarkr-users")||"{}");
    if(!users[username] || users[username].password !== password) {
      setError("Invalid username or password");
      return;
    }
    setError("");
    onLogin({username});
  }

  return (
    <div className="flex flex-col items-center justify-center h-full px-4 max-w-md mx-auto">
      <h2 className="text-4xl font-extrabold mb-6">Login</h2>
      {error && <div className="bg-red-600 text-white p-3 rounded mb-4 w-full text-center">{error}</div>}
      <form onSubmit={handleSubmit} className="w-full flex flex-col gap-5">
        <input
          type="text"
          placeholder="Username"
          className="p-3 rounded bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400"
          value={username}
          onChange={e => setUsername(e.target.value)}
          autoComplete="username"
          required
          spellCheck={false}
          autoFocus
        />
        <input
          type="password"
          placeholder="Password"
          className="p-3 rounded bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400"
          value={password}
          onChange={e => setPassword(e.target.value)}
          autoComplete="current-password"
          required
          spellCheck={false}
        />
        <button
          type="submit"
          className="py-3 bg-indigo-600 rounded font-semibold hover:bg-indigo-700 transition"
        >
          Login
        </button>
      </form>
      <p className="mt-4 text-gray-400 text-center">
        Don't have an account?{" "}
        <button
          className="text-indigo-400 underline"
          onClick={onSwitchToRegister}
        >
          Register
        </button>
      </p>
    </div>
  );
}

function RegisterForm({ onRegister, onSwitchToLogin }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");
  const [error,setError] = useState("");

  function handleSubmit(e) {
    e.preventDefault();
    if(!username.trim() || !password) {
      setError("Please enter username and password");
      return;
    }
    if(password !== password2) {
      setError("Passwords do not match");
      return;
    }
    const users = JSON.parse(localStorage.getItem("geomarkr-users")||"{}");
    if(users[username]) {
      setError("Username already exists");
      return;
    }
    users[username] = {password};
    localStorage.setItem("geomarkr-users", JSON.stringify(users));
    onRegister({username});
  }

  return (
    <div className="flex flex-col items-center justify-center h-full px-4 max-w-md mx-auto">
      <h2 className="text-4xl font-extrabold mb-6">Register</h2>
      {error && <div className="bg-red-600 text-white p-3 rounded mb-4 w-full text-center">{error}</div>}
      <form onSubmit={handleSubmit} className="w-full flex flex-col gap-5">
        <input
          type="text"
          placeholder="Username"
          className="p-3 rounded bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400"
          value={username}
          onChange={e => setUsername(e.target.value)}
          autoComplete="username"
          required
          spellCheck={false}
          autoFocus
        />
        <input
          type="password"
          placeholder="Password"
          className="p-3 rounded bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400"
          value={password}
          onChange={e => setPassword(e.target.value)}
          autoComplete="new-password"
          required
          spellCheck={false}
        />
        <input
          type="password"
          placeholder="Confirm Password"
          className="p-3 rounded bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400"
          value={password2}
          onChange={e => setPassword2(e.target.value)}
          autoComplete="new-password"
          required
          spellCheck={false}
        />
        <button
          type="submit"
          className="py-3 bg-indigo-600 rounded font-semibold hover:bg-indigo-700 transition"
        >
          Register
        </button>
      </form>
      <p className="mt-4 text-gray-400 text-center">
        Already have an account?{" "}
        <button
          className="text-indigo-400 underline"
          onClick={onSwitchToLogin}
        >
          Login
        </button>
      </p>
    </div>
  );
}

function MapEditor({ user, onLogout }) {
  const [worldTopoJSON, setWorldTopoJSON] = useState(null);
  const [countryColors, setCountryColors] = useState(() => {
    const saved = localStorage.getItem(`geomarkr-colors-${user.username}`);
    return saved ? JSON.parse(saved) : {};
  });
  const [selectedColor, setSelectedColor] = useState(COLORS[0]);
  const [searchTerm, setSearchTerm] = useState("");
  const tooltipRef = useRef(null);

  // Load topojson on mount
  useEffect(() => {
    fetch(WORLD_TOPOJSON_URL)
      .then(res => res.json())
      .then(data => setWorldTopoJSON(data))
      .catch(() => alert("Failed to load map data"));
  }, []);

  // Save colors on change
  useEffect(() => {
    localStorage.setItem(`geomarkr-colors-${user.username}`, JSON.stringify(countryColors));
  }, [countryColors, user.username]);

  // Handle tooltip movement
  function handleMouseMove(e, name) {
    if (!tooltipRef.current) return;
    if (!name) {
      tooltipRef.current.style.display = "none";
      return;
    }
    tooltipRef.current.style.display = "block";
    const offsetX = 15;
    const offsetY = -35;
    tooltipRef.current.style.left = (e.pageX + offsetX) + "px";
    tooltipRef.current.style.top = (e.pageY + offsetY) + "px";
    tooltipRef.current.textContent = name;
  }

  // Paint country on click
  function handleCountryClick(iso) {
    setCountryColors(prev => ({
      ...prev,
      [iso]: selectedColor,
    }));
  }

  if (!worldTopoJSON) {
    return (
      <div className="flex items-center justify-center h-full text-indigo-400 text-xl font-semibold">
        Loading map data...
      </div>
    );
  }

  const countriesGeoJSON = feature(worldTopoJSON, worldTopoJSON.objects.countries);

  // Filter countries by search term
  const filteredCountries = countriesGeoJSON.features.filter(({properties}) =>
    properties.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  // Export SVG to PNG
  function exportPNG() {
    const svg = document.querySelector("svg");
    if(!svg) return alert("SVG not found");

    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svg);

    const canvas = document.createElement("canvas");
    canvas.width = svg.clientWidth * 2;
    canvas.height = svg.clientHeight * 2;
    const ctx = canvas.getContext("2d");

    const img = new Image();
    const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);

    img.onload = () => {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      const pngUrl = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.download = "geomarkr-map.png";
      link.href = pngUrl;
      link.click();
    };
    img.onerror = () => alert("Failed to export PNG");
    img.src = url;
  }

  const projection = geoMercator()
    .scale(140)
    .translate([900 / 2, 500 / 1.9]);

  const pathGenerator = geoPath().projection(projection);

  return (
    <div className="flex flex-col h-full w-full bg-gradient-to-b from-gray-900 to-gray-800 text-white select-none">
      {/* Header */}
      <header className="flex justify-between items-center px-8 py-4 border-b border-gray-700 bg-gray-900">
        <h1 className="text-2xl font-extrabold tracking-wide text-indigo-400">Geomarkr Map Editor</h1>
        <div className="flex items-center gap-4">
          <span className="text-sm text-gray-400">Logged in as <strong>{user.username}</strong></span>
          <button
            onClick={onLogout}
            className="px-4 py-2 bg-red-600 rounded-md hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-500"
            aria-label="Logout"
          >
            Logout
          </button>
        </div>
      </header>

      {/* Main content */}
      <div className="flex flex-1 overflow-hidden">
        {/* Sidebar */}
        <aside className="w-72 bg-gray-900 border-r border-gray-700 flex flex-col p-5 gap-6 overflow-auto scrollbar-thin scrollbar-thumb-indigo-600 scrollbar-track-gray-900">
          <input
            type="search"
            placeholder="Search countries..."
            className="px-3 py-2 rounded-md bg-gray-800 placeholder-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400"
            value={searchTerm}
            onChange={e => setSearchTerm(e.target.value)}
            aria-label="Search countries"
          />
          <div className="flex flex-wrap gap-3 max-h-[250px] overflow-auto">
            {COLORS.map((color) => (
              <button
                key={color}
                aria-label={`Select color ${color}`}
                className={`w-8 h-8 rounded-md border-2 ${selectedColor === color ? 'border-white' : 'border-transparent'} shadow-md`}
                style={{backgroundColor: color}}
                onClick={() => setSelectedColor(color)}
              />
            ))}
          </div>

          <button
            onClick={exportPNG}
            className="mt-auto bg-indigo-600 py-3 rounded-md font-semibold hover:bg-indigo-700 transition"
            aria-label="Export map as PNG"
          >
            Export as PNG
          </button>
        </aside>

        {/* Map container */}
        <main className="flex-1 flex justify-center items-center p-6 overflow-auto">
          <svg
            width={900}
            height={500}
            className="rounded-lg shadow-lg bg-gray-900 border border-gray-700"
            role="img"
            aria-label="World map"
          >
            {filteredCountries.map(({geometry, properties}) => (
              <path
                key={properties.iso_a3}
                d={pathGenerator(geometry)}
                fill={countryColors[properties.iso_a3] || "#2d3748"}
                stroke="#4a5568"
                strokeWidth={0.5}
                className="cursor-pointer hover:stroke-indigo-400 transition-colors"
                onClick={() => handleCountryClick(properties.iso_a3)}
                onMouseMove={e => handleMouseMove(e, properties.name)}
                onMouseLeave={e => handleMouseMove(e, null)}
                tabIndex={0}
                aria-label={`Country: ${properties.name}`}
                onKeyDown={e => {
                  if(e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    handleCountryClick(properties.iso_a3);
                  }
                }}
              />
            ))}
          </svg>
        </main>
      </div>

      <div
        ref={tooltipRef}
        style={{
          position: "absolute",
          padding: "6px 12px",
          backgroundColor: "rgba(0,0,0,0.75)",
          borderRadius: "4px",
          pointerEvents: "none",
          color: "white",
          fontSize: "0.85rem",
          display: "none",
          zIndex: 1000,
        }}
        id="tooltip"
      />
    </div>
  );
}

function ChooseMap({ onBack, onStartEditing }) {
  // For now, just a simple static list, you can extend with real map sets if wanted
  const mapOptions = [
    "World",
    "Europe",
    "Europe Extended",
    "Europe Drawn",
    "Middle East",
    "Balkans",
    "German Empire",
    "Asia",
    "Africa",
    "North America",
    "South America",
    "United States",
  ];
  const [search, setSearch] = useState("");
  const [selectedMap, setSelectedMap] = useState("World");

  const filtered = mapOptions.filter(m =>
    m.toLowerCase().includes(search.toLowerCase())
  );

  return (
    <div className="flex flex-col h-full p-8 bg-gray-900 text-white select-none">
      <header className="flex justify-between items-center mb-6">
        <h2 className="text-3xl font-extrabold text-indigo-400">Choose map</h2>
        <button
          onClick={onBack}
          className="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 transition"
          aria-label="Back"
        >
          Back
        </button>
      </header>
      <input
        type="search"
        placeholder="Search..."
        className="px-4 py-3 mb-6 rounded bg-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400"
        value={search}
        onChange={e => setSearch(e.target.value)}
        aria-label="Search maps"
      />
      <div className="flex flex-col gap-3 max-h-[320px] overflow-auto scrollbar-thin scrollbar-thumb-indigo-600 scrollbar-track-gray-900">
        {filtered.map(map => (
          <button
            key={map}
            className={`text-left px-5 py-3 rounded border border-gray-700 hover:border-indigo-500 transition ${
              selectedMap === map ? "bg-indigo-600 text-white font-semibold" : "text-gray-300"
            }`}
            onClick={() => setSelectedMap(map)}
            aria-pressed={selectedMap === map}
          >
            {map}
          </button>
        ))}
      </div>
      <button
        onClick={() => onStartEditing(selectedMap)}
        className="mt-auto w-full bg-indigo-600 py-4 rounded font-bold text-lg hover:bg-indigo-700 transition"
        aria-label="Confirm selected map"
      >
        CONFIRM
      </button>
    </div>
  );
}

// Main app
function App() {
  const [mode, setMode] = useState("intro"); // intro, login, register, chooseMap, editor
  const [user, setUser] = useState(null);
  const [chosenMap, setChosenMap] = useState(null);

  // No account needed to start editing:
  function startEditing(mapName) {
    setChosenMap(mapName);
    setMode("editor");
  }

  function handleLogin(u) {
    setUser(u);
    setChosenMap(null);
    setMode("chooseMap");
  }
  function handleLogout() {
    setUser(null);
    setChosenMap(null);
    setMode("intro");
  }
  function handleRegister(u) {
    setUser(u);
    setChosenMap(null);
    setMode("chooseMap");
  }

  return (
    <div className="h-full flex flex-col">
      {mode === "intro" && (
        <Intro
          onCreateAccount={() => setMode("register")}
          onCreateMap={() => setMode("chooseMap")}
        />
      )}

      {mode === "login" && (
        <LoginForm
          onLogin={handleLogin}
          onSwitchToRegister={() => setMode("register")}
        />
      )}

      {mode === "register" && (
        <RegisterForm
          onRegister={handleRegister}
          onSwitchToLogin={() => setMode("login")}
        />
      )}

      {mode === "chooseMap" && (
        <ChooseMap
          onBack={() => (user ? setMode("chooseMap") : setMode("intro"))}
          onStartEditing={startEditing}
        />
      )}

      {mode === "editor" && (
        <MapEditor
          user={user || {username: "Guest"}}
          onLogout={handleLogout}
        />
      )}
    </div>
  );
}

// Render app
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>

