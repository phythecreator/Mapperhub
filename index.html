<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GameHub Multiplayer - Plataforma de Jogos</title>
<style>
  /* Estilos modernos e responsivos */
  :root {
    --bg: #121212;
    --primary: #00c896;
    --primary-dark: #009e6b;
    --text-light: #eee;
    --text-muted: #999;
    --card-bg: #222;
    --btn-bg: #00c896;
    --btn-hover: #009e6b;
    --shadow: 0 8px 24px rgba(0, 200, 150, 0.3);
  }
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    background: var(--bg);
    color: var(--text-light);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    width: 100%;
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    text-align: center;
    box-shadow: var(--shadow);
  }
  header h1 {
    font-weight: 900;
    font-size: 2.5rem;
    letter-spacing: 0.05em;
    user-select: none;
  }
  main {
    flex: 1;
    width: 100%;
    max-width: 1200px;
    padding: 1.5rem;
  }
  .hide {
    display: none !important;
  }
  button {
    cursor: pointer;
    background: var(--btn-bg);
    border: none;
    padding: 0.7rem 1.4rem;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: var(--btn-hover);
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  input[type="text"] {
    background: var(--card-bg);
    border: none;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    color: var(--text-light);
    font-size: 1rem;
    width: 200px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    user-select: all;
  }
  label {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    display: block;
  }
  .center {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .flex-row {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .section-title {
    text-align: center;
    font-weight: 700;
    font-size: 1.8rem;
    margin-bottom: 1rem;
    letter-spacing: 0.05em;
    user-select: none;
  }
  #status-bar {
    text-align: center;
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    min-height: 1.2rem;
    user-select: none;
  }
  .game-list {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 20px;
    margin-top: 1rem;
  }
  .game-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 1rem;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    user-select: none;
  }
  .game-card h3 {
    margin-bottom: 0.8rem;
    font-weight: 700;
    font-size: 1.3rem;
  }
  .game-card button {
    margin-top: auto;
  }
  #game-area {
    margin-top: 2rem;
    position: relative;
    width: 100%;
    height: 650px;
    background: #111;
    border-radius: 16px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  #game-canvas {
    display: block;
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 16px;
  }
  #exit-game {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(0, 200, 150, 0.8);
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 700;
    color: #000;
    cursor: pointer;
    z-index: 10;
    transition: background-color 0.3s ease;
  }
  #exit-game:hover {
    background: var(--btn-hover);
    color: white;
  }
  #room-code-display {
    font-family: monospace;
    font-weight: 900;
    font-size: 1.2rem;
    background: var(--card-bg);
    color: var(--primary);
    padding: 6px 10px;
    border-radius: 12px;
    letter-spacing: 0.15em;
    user-select: all;
    margin-top: 8px;
    text-align: center;
  }
  #join-room-input {
    text-transform: uppercase;
  }
  /* Scroll para jogos extensos */
  #game-area > * {
    max-height: 100%;
    overflow: auto;
  }
  /* Botão não disponível */
  .disabled-btn {
    background: #555 !important;
    cursor: not-allowed !important;
  }
  /* Mensagem do jogo */
  #game-message {
    position: absolute;
    width: 100%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--primary);
    font-size: 2rem;
    font-weight: 700;
    user-select: none;
    pointer-events: none;
  }
</style>
</head>
<body>

<header>
  <h1>🎮 GameHub Multiplayer</h1>
</header>

<main>

  <!-- Tela de Criar / Entrar sala -->
  <section id="screen-lobby" class="center">
    <div class="section-title">Criar ou Entrar numa Sala</div>
    <div class="flex-row" style="margin-bottom:1rem;">
      <button id="btn-create-room">Criar Sala</button>
      <div>
        <label for="join-room-input">Código da Sala:</label>
        <input type="text" id="join-room-input" maxlength="5" placeholder="Ex: 76378" />
      </div>
      <button id="btn-join-room">Entrar</button>
    </div>
    <div id="lobby-status" style="color:#ddd; font-size:1rem; user-select:none;"></div>
  </section>

  <!-- Tela de seleção de jogos -->
  <section id="screen-game-select" class="hide">
    <div class="section-title">Escolha o jogo</div>
    <div id="status-bar"></div>
    <div class="game-list" id="game-list">
      <!-- Cartões de jogos adicionados dinamicamente -->
    </div>
  </section>

  <!-- Área do jogo -->
  <section id="screen-game-play" class="hide" style="position:relative;">
    <button id="exit-game">Sair do Jogo</button>
    <canvas id="game-canvas" width="960" height="600"></canvas>
    <div id="game-message"></div>
  </section>

</main>

<script>
(() => {
  // Constantes básicas
  const MAX_JOGADORES = 6;
  const SALAS_KEY = 'gamehub_salas';
  const DURATION_SALA_MS = 3 * 60 * 60 * 1000; // 3 horas

  // Estado
  let PLAYER_ID = 'player-' + Math.floor(Math.random() * 999999);
  let PLAYER_NAME = 'Jogador ' + PLAYER_ID.slice(-4);
  let currentRoomCode = null;
  let salas = {};
  let currentSala = null;
  let currentJogoId = null;
  let gameInstance = null;
  let gameCanvas = document.getElementById('game-canvas');
  let ctx = gameCanvas.getContext('2d');
  let keys = {};

  // DOM
  const screenLobby = document.getElementById('screen-lobby');
  const screenGameSelect = document.getElementById('screen-game-select');
  const screenGamePlay = document.getElementById('screen-game-play');
  const joinRoomInput = document.getElementById('join-room-input');
  const btnCreateRoom = document.getElementById('btn-create-room');
  const btnJoinRoom = document.getElementById('btn-join-room');
  const gameListEl = document.getElementById('game-list');
  const exitGameBtn = document.getElementById('exit-game');
  const statusBar = document.getElementById('status-bar');
  const lobbyStatus = document.getElementById('lobby-status');
  const gameMessage = document.getElementById('game-message');

  // Jogos definidos: 10 embutidos + outros bloqueados
  const jogos = [
    {id:'fut1', nome:'Futebol 1v1', func:initFutebol1v1},
    {id:'fut2', nome:'Futebol 2v2', func:initFutebol2v2},
    {id:'fut3', nome:'Futebol Arcade', func:initFutebolArcade},
    {id:'lut1', nome:'Luta Rua 1v1', func:initLutaRua1v1},
    {id:'lut2', nome:'Luta Rua 2v2', func:initLutaRua2v2},
    {id:'corr1', nome:'Corrida Maluca', func:initCorridaMaluca},
    {id:'corr2', nome:'Corrida Kart', func:initCorridaKart},
    {id:'slot1', nome:'Slots Casino', func:initSlotsCasino},
    {id:'quiz1', nome:'Quiz Geral', func:initQuizGeral},
    {id:'quiz2', nome:'Quiz Cultura Geral', func:initQuizCultura},
    // Jogos bloqueados
    {id:'jogo11', nome:'Jogo 11 (Não disponível)', func:gameNaoDisponivel},
    {id:'jogo12', nome:'Jogo 12 (Não disponível)', func:gameNaoDisponivel},
    {id:'jogo13', nome:'Jogo 13 (Não disponível)', func:gameNaoDisponivel},
    {id:'jogo14', nome:'Jogo 14 (Não disponível)', func:gameNaoDisponivel},
    {id:'jogo15', nome:'Jogo 15 (Não disponível)', func:gameNaoDisponivel}
  ];

  // ----- Utilitários -----
  function salvarSalas() {
    salas[currentRoomCode] = currentSala;
    localStorage.setItem(SALAS_KEY, JSON.stringify(salas));
  }
  function carregarSalas() {
    const s = localStorage.getItem(SALAS_KEY);
    salas = s ? JSON.parse(s) : {};
    limparSalasExpiradas();
    return salas;
  }
  function limparSalasExpiradas() {
    const now = Date.now();
    for(let codigo in salas) {
      if(!salas[codigo]) continue;
      if(now - (salas[codigo].ultimaAtividade || 0) > DURATION_SALA_MS) {
        delete salas[codigo];
      }
    }
    localStorage.setItem(SALAS_KEY, JSON.stringify(salas));
  }
  function gerarCodigoSala() {
    let cod = '';
    for(let i=0;i<5;i++){
      cod += Math.floor(Math.random()*10);
    }
    return cod;
  }
  function atualizarStatus(msg) {
    statusBar.textContent = msg;
  }

  // ----- Lógica para criar e entrar salas -----
  btnCreateRoom.onclick = () => {
    carregarSalas();
    let novoCodigo;
    do {
      novoCodigo = gerarCodigoSala();
    } while (salas[novoCodigo]);
    currentRoomCode = novoCodigo;
    currentSala = {
      jogadores: [],
      jogoId: null,
      ultimaAtividade: Date.now()
    };
    salas[currentRoomCode] = currentSala;
    salvarSalas();
    entrarSala(currentRoomCode);
  };

  btnJoinRoom.onclick = () => {
    const codigo = joinRoomInput.value.trim();
    if(codigo.length !== 5 || isNaN(codigo)) {
      alert('Código inválido. Deve ter 5 dígitos numéricos.');
      return;
    }
    carregarSalas();
    if(!salas[codigo]){
      alert('Sala não encontrada.');
      return;
    }
    entrarSala(codigo);
  };

  function entrarSala(codigo) {
    currentRoomCode = codigo;
    carregarSalas();
    currentSala = salas[codigo];
    if(!currentSala) {
      alert('Sala inválida ou expirada.');
      return;
    }
    // Verifica limite jogadores
    if(currentSala.jogadores.length >= MAX_JOGADORES) {
      alert('Sala cheia!');
      return;
    }
    // Verifica se jogador já está na sala
    let existe = currentSala.jogadores.find(j => j.id === PLAYER_ID);
    if(!existe) {
      currentSala.jogadores.push({
        id: PLAYER_ID,
        nome: PLAYER_NAME,
        bot:false,
        estado:{}
      });
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }
    lobbyStatus.textContent = `Sala: ${codigo} | Jogadores: ${currentSala.jogadores.length}`;
    mostrarSelecaoJogos();
  }

  // Exibe tela de seleção de jogos
  function mostrarSelecaoJogos(){
    screenLobby.classList.add('hide');
    screenGameSelect.classList.remove('hide');
    screenGamePlay.classList.add('hide');
    atualizarListaJogos();
    statusBar.textContent = `Sala: ${currentRoomCode} | Jogadores: ${currentSala.jogadores.length}`;
    preencherBots();
  }

  // Bot simples preenche a sala até 6 jogadores
  function preencherBots(){
    let mudou = false;
    while(currentSala.jogadores.length < MAX_JOGADORES){
      let botId = 'bot-' + Math.floor(Math.random()*999999);
      if(currentSala.jogadores.find(j => j.id === botId)) break;
      currentSala.jogadores.push({
        id: botId,
        nome: 'BOT ' + botId.slice(-4),
        bot: true,
        estado: {}
      });
      mudou = true;
    }
    if(mudou){
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
      lobbyStatus.textContent = `Sala: ${currentRoomCode} | Jogadores: ${currentSala.jogadores.length}`;
      statusBar.textContent = `Sala: ${currentRoomCode} | Jogadores: ${currentSala.jogadores.length}`;
    }
  }

  // Atualiza lista de jogos na UI
  function atualizarListaJogos(){
    gameListEl.innerHTML = '';
    jogos.forEach(j => {
      const card = document.createElement('div');
      card.className = 'game-card';
      const title = document.createElement('h3');
      title.textContent = j.nome;
      card.appendChild(title);
      const btn = document.createElement('button');
      btn.textContent = j.func === gameNaoDisponivel ? 'Não disponível' : 'Jogar';
      if(j.func === gameNaoDisponivel) btn.classList.add('disabled-btn');
      btn.disabled = (j.func === gameNaoDisponivel);
      btn.onclick = () => {
        iniciarJogo(j.id);
      };
      card.appendChild(btn);
      gameListEl.appendChild(card);
    });
  }

  // Iniciar jogo selecionado
  function iniciarJogo(jogoId){
    if(!currentSala) {
      alert('Entre em uma sala primeiro.');
      return;
    }
    currentJogoId = jogoId;
    currentSala.jogoId = jogoId;
    currentSala.ultimaAtividade = Date.now();
    salvarSalas();

    screenGameSelect.classList.add('hide');
    screenGamePlay.classList.remove('hide');
    limparCanvas();
    atualizarStatus(`Jogando: ${jogos.find(j => j.id === jogoId).nome}`);

    // Inicia o jogo embutido
    const jogo = jogos.find(j => j.id === jogoId);
    if(!jogo) {
      alert('Jogo não encontrado');
      voltarParaSelecao();
      return;
    }
    jogo.func();
  }

  // Limpar canvas e mensagens
  function limparCanvas(){
    ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    gameMessage.textContent = '';
  }

  // Voltar para seleção de jogos
  function voltarParaSelecao(){
    if(gameInstance && gameInstance.cleanup) gameInstance.cleanup();
    gameInstance = null;
    currentJogoId = null;
    screenGamePlay.classList.add('hide');
    screenGameSelect.classList.remove('hide');
    atualizarStatus('');
  }

  exitGameBtn.onclick = voltarParaSelecao;

  // ====== GESTÃO DE INPUT =======
  window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if(gameInstance && gameInstance.onKeyDown) gameInstance.onKeyDown(e.key.toLowerCase());
  });
  window.addEventListener('keyup', e => {
    keys[e.key.toLowerCase()] = false;
    if(gameInstance && gameInstance.onKeyUp) gameInstance.onKeyUp(e.key.toLowerCase());
  });

  // ====== SINCRONIZAÇÃO MULTIPLAYER via localStorage ======
  window.addEventListener('storage', e => {
    if(e.key !== SALAS_KEY) return;
    carregarSalas();
    if(!currentRoomCode) return;
    if(!salas[currentRoomCode]) {
      alert('Sala foi fechada ou expirada!');
      location.reload();
      return;
    }
    currentSala = salas[currentRoomCode];
    if(gameInstance && gameInstance.onSalaAtualizada) gameInstance.onSalaAtualizada(currentSala);
    lobbyStatus.textContent = `Sala: ${currentRoomCode} | Jogadores: ${currentSala.jogadores.length}`;
    statusBar.textContent = `Sala: ${currentRoomCode} | Jogadores: ${currentSala.jogadores.length}`;
  });

  // ======= JOGOS =======

  // -- 1) Futebol 1v1 -- Simples com movimentação e gol
  function initFutebol1v1(){
    let players = [];
    let bola = {x: gameCanvas.width/2, y: gameCanvas.height/2, r: 12, speedX: 0, speedY: 0};
    const speed = 4;
    const bolaFriccao = 0.98;
    const golLargura = 100;
    const golAltura = 150;
    let placar = [0,0];

    // Pos inicial jogadores (2)
    function criarPlayers() {
      players = [];
      currentSala.jogadores.forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: idx === 0 ? 100 : gameCanvas.width - 100,
          y: gameCanvas.height/2,
          w: 30, h: 50,
          dirX:0, dirY:0,
          cor: idx === 0 ? '#00c896' : '#c90000',
          velocidade: speed
        });
      });
    }

    criarPlayers();

    function desenha() {
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
      // Fundo campo
      ctx.fillStyle = '#117a29';
      ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
      // Meio campo
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(gameCanvas.width/2, 0);
      ctx.lineTo(gameCanvas.width/2, gameCanvas.height);
      ctx.stroke();
      // Gol esquerdo
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, (gameCanvas.height-golAltura)/2, 10, golAltura);
      // Gol direito
      ctx.fillRect(gameCanvas.width-10, (gameCanvas.height-golAltura)/2, 10, golAltura);

      // Jogadores
      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x-p.w/2,p.y-p.h/2,p.w,p.h);
        ctx.fillStyle = '#000';
        ctx.fillText(p.nome, p.x-20, p.y-p.h/2-10);
      });

      // Bola
      ctx.beginPath();
      ctx.fillStyle = '#fff';
      ctx.arc(bola.x, bola.y, bola.r, 0, Math.PI*2);
      ctx.fill();

      // Placar
      ctx.fillStyle = '#fff';
      ctx.font = '24px monospace';
      ctx.fillText(`Placar: ${placar[0]} - ${placar[1]}`, gameCanvas.width/2 - 50, 30);
    }

    // Colisão bola com jogador
    function bolaColisaoJogador(p){
      let dx = bola.x - p.x;
      let dy = bola.y - p.y;
      let dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < bola.r + p.w/2){
        // Rebote simples com direção
        let ang = Math.atan2(dy, dx);
        bola.speedX = Math.cos(ang)*7;
        bola.speedY = Math.sin(ang)*7;
      }
    }

    // Colisão bola com gol
    function verificaGol(){
      if(bola.x - bola.r <= 10){
        // Gol direito marcou
        if(bola.y > (gameCanvas.height-golAltura)/2 && bola.y < (gameCanvas.height+golAltura)/2){
          placar[1]++;
          resetarBola();
        }
      }
      if(bola.x + bola.r >= gameCanvas.width-10){
        // Gol esquerdo marcou
        if(bola.y > (gameCanvas.height-golAltura)/2 && bola.y < (gameCanvas.height+golAltura)/2){
          placar[0]++;
          resetarBola();
        }
      }
    }
    function resetarBola(){
      bola.x = gameCanvas.width/2;
      bola.y = gameCanvas.height/2;
      bola.speedX = 0;
      bola.speedY = 0;
    }

    // Atualiza jogadores (humanos e bots)
    function atualizarPlayers(){
      players.forEach(p => {
        if(p.bot){
          // Bots se movem aleatoriamente, tentam acertar na bola
          let dx = bola.x - p.x;
          let dy = bola.y - p.y;
          let dist = Math.sqrt(dx*dx+dy*dy);
          if(dist > 50){
            p.dirX = dx > 0 ? 1 : -1;
            p.dirY = dy > 0 ? 1 : -1;
          } else {
            p.dirX = 0; p.dirY = 0;
          }
        } else {
          // Humanos movimentam-se via WASD ou setas se forem o jogador 1 ou 2
          if(p.id === PLAYER_ID){
            p.dirX = 0; p.dirY = 0;
            if(keys['a']) p.dirX = -1;
            else if(keys['d']) p.dirX = 1;
            if(keys['w']) p.dirY = -1;
            else if(keys['s']) p.dirY = 1;
          }
        }
        // Atualiza posicao
        p.x += p.dirX * p.velocidade;
        p.y += p.dirY * p.velocidade;
        // Limites campo
        p.x = Math.max(p.w/2, Math.min(gameCanvas.width-p.w/2, p.x));
        p.y = Math.max(p.h/2, Math.min(gameCanvas.height-p.h/2, p.y));
      });
    }

    // Atualiza bola
    function atualizarBola(){
      bola.x += bola.speedX;
      bola.y += bola.speedY;
      bola.speedX *= bolaFriccao;
      bola.speedY *= bolaFriccao;
      // Limites bola
      if(bola.y - bola.r < 0 || bola.y + bola.r > gameCanvas.height){
        bola.speedY = -bola.speedY;
        bola.y = bola.y - bola.r < 0 ? bola.r : gameCanvas.height - bola.r;
      }
      if(bola.x - bola.r < 0 || bola.x + bola.r > gameCanvas.width){
        bola.speedX = -bola.speedX;
        bola.x = bola.x - bola.r < 0 ? bola.r : gameCanvas.width - bola.r;
      }
      // Colisao com jogadores
      players.forEach(bolaColisaoJogador);
      // Verifica gol
      verificaGol();
    }

    // Envia estado para sala e salva
    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({id:p.id, x:p.x, y:p.y, dirX:p.dirX, dirY:p.dirY, cor:p.cor})),
        bola: {...bola},
        placar: [...placar]
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    // Atualiza estado do jogo da sala
    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      // Atualiza jogadores
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y;
          p.dirX = pj.dirX; p.dirY = pj.dirY;
        }
      });
      bola.x = e.bola.x; bola.y = e.bola.y;
      bola.speedX = e.bola.speedX; bola.speedY = e.bola.speedY;
      placar = [...e.placar];
    }

    // Loop principal do jogo
    function loop(){
      atualizarPlayers();
      atualizarBola();
      desenha();
      enviarEstado();
    }

    // Começa o jogo
    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => { 
        currentSala = sala; 
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 2) Futebol 2v2 (simplificado baseado no 1v1) --
  function initFutebol2v2(){
    // Para brevidade, jogo idêntico ao 1v1 só com até 4 jogadores, bots e humanos,
    // campo maior e times divididos.
    // Implementação básica:
    let players = [];
    let bola = {x: gameCanvas.width/2, y: gameCanvas.height/2, r: 12, speedX: 0, speedY: 0};
    const speed = 4;
    const bolaFriccao = 0.98;
    const golLargura = 150;
    const golAltura = 150;
    let placar = [0,0];

    function criarPlayers() {
      players = [];
      currentSala.jogadores.slice(0,4).forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: (idx < 2 ? 100 : gameCanvas.width - 100),
          y: 150 + (idx % 2) * 300,
          w: 30, h: 50,
          dirX:0, dirY:0,
          cor: idx < 2 ? '#00c896' : '#c90000',
          velocidade: speed
        });
      });
    }

    criarPlayers();

    function desenha() {
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
      // Fundo campo
      ctx.fillStyle = '#117a29';
      ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
      // Meio campo
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(gameCanvas.width/2, 0);
      ctx.lineTo(gameCanvas.width/2, gameCanvas.height);
      ctx.stroke();
      // Gols
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, (gameCanvas.height-golAltura)/2, 10, golAltura);
      ctx.fillRect(gameCanvas.width-10, (gameCanvas.height-golAltura)/2, 10, golAltura);

      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x-p.w/2,p.y-p.h/2,p.w,p.h);
        ctx.fillStyle = '#000';
        ctx.fillText(p.nome, p.x-20, p.y-p.h/2-10);
      });

      ctx.beginPath();
      ctx.fillStyle = '#fff';
      ctx.arc(bola.x, bola.y, bola.r, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = '#fff';
      ctx.font = '24px monospace';
      ctx.fillText(`Placar: ${placar[0]} - ${placar[1]}`, gameCanvas.width/2 - 50, 30);
    }

    function bolaColisaoJogador(p){
      let dx = bola.x - p.x;
      let dy = bola.y - p.y;
      let dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < bola.r + p.w/2){
        let ang = Math.atan2(dy, dx);
        bola.speedX = Math.cos(ang)*7;
        bola.speedY = Math.sin(ang)*7;
      }
    }

    function verificaGol(){
      if(bola.x - bola.r <= 10){
        if(bola.y > (gameCanvas.height-golAltura)/2 && bola.y < (gameCanvas.height+golAltura)/2){
          placar[1]++;
          resetarBola();
        }
      }
      if(bola.x + bola.r >= gameCanvas.width-10){
        if(bola.y > (gameCanvas.height-golAltura)/2 && bola.y < (gameCanvas.height+golAltura)/2){
          placar[0]++;
          resetarBola();
        }
      }
    }
    function resetarBola(){
      bola.x = gameCanvas.width/2;
      bola.y = gameCanvas.height/2;
      bola.speedX = 0;
      bola.speedY = 0;
    }

    function atualizarPlayers(){
      players.forEach(p => {
        if(p.bot){
          let dx = bola.x - p.x;
          let dy = bola.y - p.y;
          let dist = Math.sqrt(dx*dx+dy*dy);
          if(dist > 50){
            p.dirX = dx > 0 ? 1 : -1;
            p.dirY = dy > 0 ? 1 : -1;
          } else {
            p.dirX = 0; p.dirY = 0;
          }
        } else {
          if(p.id === PLAYER_ID){
            p.dirX = 0; p.dirY = 0;
            if(keys['a']) p.dirX = -1;
            else if(keys['d']) p.dirX = 1;
            if(keys['w']) p.dirY = -1;
            else if(keys['s']) p.dirY = 1;
          }
        }
        p.x += p.dirX * p.velocidade;
        p.y += p.dirY * p.velocidade;
        p.x = Math.max(p.w/2, Math.min(gameCanvas.width-p.w/2, p.x));
        p.y = Math.max(p.h/2, Math.min(gameCanvas.height-p.h/2, p.y));
      });
    }

    function atualizarBola(){
      bola.x += bola.speedX;
      bola.y += bola.speedY;
      bola.speedX *= bolaFriccao;
      bola.speedY *= bolaFriccao;
      if(bola.y - bola.r < 0 || bola.y + bola.r > gameCanvas.height){
        bola.speedY = -bola.speedY;
        bola.y = bola.y - bola.r < 0 ? bola.r : gameCanvas.height - bola.r;
      }
      if(bola.x - bola.r < 0 || bola.x + bola.r > gameCanvas.width){
        bola.speedX = -bola.speedX;
        bola.x = bola.x - bola.r < 0 ? bola.r : gameCanvas.width - bola.r;
      }
      players.forEach(bolaColisaoJogador);
      verificaGol();
    }

    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({id:p.id,x:p.x,y:p.y,dirX:p.dirX,dirY:p.dirY,cor:p.cor})),
        bola: {...bola},
        placar: [...placar]
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y;
          p.dirX = pj.dirX; p.dirY = pj.dirY;
        }
      });
      bola.x = e.bola.x; bola.y = e.bola.y;
      bola.speedX = e.bola.speedX; bola.speedY = e.bola.speedY;
      placar = [...e.placar];
    }

    function loop(){
      atualizarPlayers();
      atualizarBola();
      desenha();
      enviarEstado();
    }

    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => {
        currentSala = sala;
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 3) Futebol Arcade (simples jogo com movimento e gol, bot random) --
  function initFutebolArcade(){
    // Similar ao 1v1 com regras arcade
    // Por simplicidade mantemos 1v1, bola simples e bot agressivo
    let players = [];
    let bola = {x: gameCanvas.width/2, y: gameCanvas.height/2, r: 14, speedX: 0, speedY: 0};
    const speed = 5;
    const bolaFriccao = 0.96;
    let placar = [0,0];

    function criarPlayers() {
      players = [];
      currentSala.jogadores.slice(0,2).forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: idx === 0 ? 80 : gameCanvas.width - 80,
          y: gameCanvas.height/2,
          w: 35, h: 50,
          dirX:0, dirY:0,
          cor: idx === 0 ? '#08f' : '#f80',
          velocidade: speed
        });
      });
    }

    criarPlayers();

    function desenha() {
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
      ctx.fillStyle = '#004400';
      ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(gameCanvas.width/2, 0);
      ctx.lineTo(gameCanvas.width/2, gameCanvas.height);
      ctx.stroke();
      // Gol
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, (gameCanvas.height-160)/2, 15, 160);
      ctx.fillRect(gameCanvas.width-15, (gameCanvas.height-160)/2, 15, 160);

      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x-p.w/2,p.y-p.h/2,p.w,p.h);
        ctx.fillStyle = '#000';
        ctx.fillText(p.nome, p.x-25, p.y-p.h/2-12);
      });

      ctx.beginPath();
      ctx.fillStyle = '#fff';
      ctx.arc(bola.x, bola.y, bola.r, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Score: ${placar[0]} - ${placar[1]}`, gameCanvas.width/2-60, 40);
    }

    function bolaColisaoJogador(p){
      let dx = bola.x - p.x;
      let dy = bola.y - p.y;
      let dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < bola.r + p.w/2){
        let ang = Math.atan2(dy, dx);
        bola.speedX = Math.cos(ang)*10;
        bola.speedY = Math.sin(ang)*10;
      }
    }

    function verificaGol(){
      if(bola.x - bola.r <= 15){
        if(bola.y > (gameCanvas.height-160)/2 && bola.y < (gameCanvas.height+160)/2){
          placar[1]++;
          resetarBola();
        }
      }
      if(bola.x + bola.r >= gameCanvas.width-15){
        if(bola.y > (gameCanvas.height-160)/2 && bola.y < (gameCanvas.height+160)/2){
          placar[0]++;
          resetarBola();
        }
      }
    }
    function resetarBola(){
      bola.x = gameCanvas.width/2;
      bola.y = gameCanvas.height/2;
      bola.speedX = 0;
      bola.speedY = 0;
    }

    function atualizarPlayers(){
      players.forEach(p => {
        if(p.bot){
          let dx = bola.x - p.x;
          let dy = bola.y - p.y;
          let dist = Math.sqrt(dx*dx+dy*dy);
          if(dist > 60){
            p.dirX = dx > 0 ? 1 : -1;
            p.dirY = dy > 0 ? 1 : -1;
          } else {
            p.dirX = 0; p.dirY = 0;
          }
        } else {
          if(p.id === PLAYER_ID){
            p.dirX = 0; p.dirY = 0;
            if(keys['a']) p.dirX = -1;
            else if(keys['d']) p.dirX = 1;
            if(keys['w']) p.dirY = -1;
            else if(keys['s']) p.dirY = 1;
          }
        }
        p.x += p.dirX * p.velocidade;
        p.y += p.dirY * p.velocidade;
        p.x = Math.max(p.w/2, Math.min(gameCanvas.width-p.w/2, p.x));
        p.y = Math.max(p.h/2, Math.min(gameCanvas.height-p.h/2, p.y));
      });
    }

    function atualizarBola(){
      bola.x += bola.speedX;
      bola.y += bola.speedY;
      bola.speedX *= bolaFriccao;
      bola.speedY *= bolaFriccao;
      if(bola.y - bola.r < 0 || bola.y + bola.r > gameCanvas.height){
        bola.speedY = -bola.speedY;
        bola.y = bola.y - bola.r < 0 ? bola.r : gameCanvas.height - bola.r;
      }
      if(bola.x - bola.r < 0 || bola.x + bola.r > gameCanvas.width){
        bola.speedX = -bola.speedX;
        bola.x = bola.x - bola.r < 0 ? bola.r : gameCanvas.width - bola.r;
      }
      players.forEach(bolaColisaoJogador);
      verificaGol();
    }

    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({id:p.id,x:p.x,y:p.y,dirX:p.dirX,dirY:p.dirY,cor:p.cor})),
        bola: {...bola},
        placar: [...placar]
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y;
          p.dirX = pj.dirX; p.dirY = pj.dirY;
        }
      });
      bola.x = e.bola.x; bola.y = e.bola.y;
      bola.speedX = e.bola.speedX; bola.speedY = e.bola.speedY;
      placar = [...e.placar];
    }

    function loop(){
      atualizarPlayers();
      atualizarBola();
      desenha();
      enviarEstado();
    }

    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => {
        currentSala = sala;
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 4) Luta Rua 1v1 --
  function initLutaRua1v1(){
    // Simples luta 1v1 lado a lado, socos e chutes
    let players = [];
    let arena = {w: gameCanvas.width, h: gameCanvas.height};
    const groundY = arena.h - 100;
    const gravidade = 1;
    const speed = 6;
    let timerRound = 60 * 60; // 60 seg a 60fps
    let vencedor = null;

    function criarPlayers() {
      players = [];
      currentSala.jogadores.slice(0,2).forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: idx === 0 ? 200 : arena.w - 200,
          y: groundY,
          w: 50,
          h: 90,
          vy: 0,
          noChao: true,
          atacando: false,
          vida: 100,
          cor: idx === 0 ? '#08f' : '#f00',
          dir: idx === 0 ? 1 : -1,
          velocidade: speed,
          ataqueCooldown: 0
        });
      });
    }
    criarPlayers();

    // Lógica física e desenho
    function desenha(){
      ctx.clearRect(0,0,arena.w,arena.h);
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,arena.w,arena.h);
      // Chao
      ctx.fillStyle = '#444';
      ctx.fillRect(0,groundY,arena.w,100);

      // Linha do meio
      ctx.strokeStyle = '#aaa';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(arena.w/2,0);
      ctx.lineTo(arena.w/2,arena.h);
      ctx.stroke();

      // Jogadores
      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x-p.w/2, p.y-p.h, p.w, p.h);
        // Vida
        ctx.fillStyle = '#0f0';
        ctx.fillRect(p.x-p.w/2, p.y-p.h-15, p.w * (p.vida/100), 8);
        ctx.fillStyle = '#fff';
        ctx.font = '14px monospace';
        ctx.fillText(p.nome, p.x - p.w/2, p.y - p.h - 25);
      });

      // Tempo round
      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Tempo: ${Math.floor(timerRound/60)}s`, arena.w/2 - 60, 50);

      if(vencedor){
        ctx.fillStyle = '#ff0';
        ctx.font = '48px monospace';
        ctx.fillText(`${vencedor} venceu!`, arena.w/2 - 120, arena.h/2);
      }
    }

    // Colisão ataque
    function colidiuAtque(atacante, defensor){
      // Simples colisao retangular frontal e vertical
      if(atacante.dir === 1){
        return (atacante.x + atacante.w/2 + 10 >= defensor.x - defensor.w/2) &&
          (atacante.x < defensor.x) &&
          (atacante.y >= defensor.y - defensor.h) &&
          (atacante.y <= defensor.y);
      } else {
        return (atacante.x - atacante.w/2 - 10 <= defensor.x + defensor.w/2) &&
          (atacante.x > defensor.x) &&
          (atacante.y >= defensor.y - defensor.h) &&
          (atacante.y <= defensor.y);
      }
    }

    // Atualiza jogadores
    function atualizarPlayers(){
      players.forEach(p => {
        if(p.ataqueCooldown > 0) p.ataqueCooldown--;
        if(p.bot){
          // Bot simples: anda em direção oponente, ataca se perto e cooldown ok
          let alvo = players.find(x => x.id !== p.id);
          if(!alvo) return;
          let dx = alvo.x - p.x;
          if(Math.abs(dx) > 70){
            p.dir = dx > 0 ? 1 : -1;
            p.x += p.dir * p.velocidade;
          } else {
            if(p.ataqueCooldown === 0){
              p.atacando = true;
              p.ataqueCooldown = 60;
            } else {
              p.atacando = false;
            }
          }
        } else {
          if(p.id === PLAYER_ID){
            if(keys['arrowleft']) {
              p.x -= p.velocidade;
              p.dir = -1;
            }
            if(keys['arrowright']) {
              p.x += p.velocidade;
              p.dir = 1;
            }
            if(keys['arrowup'] && p.noChao) {
              p.vy = -18;
              p.noChao = false;
            }
            if(keys[' ']) {
              if(p.ataqueCooldown === 0){
                p.atacando = true;
                p.ataqueCooldown = 60;
              }
            }
          }
        }
        // Gravidade
        if(!p.noChao){
          p.vy += gravidade;
          p.y += p.vy;
          if(p.y >= groundY){
            p.y = groundY;
            p.noChao = true;
            p.vy = 0;
          }
        }
        // Limites arena
        p.x = Math.max(p.w/2, Math.min(arena.w - p.w/2, p.x));
      });

      // Atacar e causar dano
      players.forEach(atacante => {
        if(atacante.atacando){
          players.forEach(defensor => {
            if(defensor.id !== atacante.id && colidiuAtque(atacante, defensor)){
              defensor.vida -= 0.7;
              if(defensor.vida <= 0 && !vencedor){
                vencedor = atacante.nome;
                gameMessage.textContent = `${vencedor} venceu!`;
              }
            }
          });
          atacante.atacando = false;
        }
      });
    }

    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({
          id: p.id, x:p.x, y:p.y, vy:p.vy, noChao:p.noChao,
          atacando:p.atacando, vida:p.vida, dir:p.dir,
          ataqueCooldown: p.ataqueCooldown
        })),
        timerRound,
        vencedor
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y; p.vy = pj.vy;
          p.noChao = pj.noChao; p.atacando = pj.atacando;
          p.vida = pj.vida; p.dir = pj.dir; p.ataqueCooldown = pj.ataqueCooldown;
        }
      });
      timerRound = e.timerRound;
      vencedor = e.vencedor;
    }

    function loop(){
      if(timerRound > 0 && !vencedor) timerRound--;
      atualizarPlayers();
      desenha();
      enviarEstado();
    }

    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => {
        currentSala = sala;
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 5) Luta Rua 2v2 --
  function initLutaRua2v2(){
    // Idêntico ao 1v1, mas até 4 jogadores, 2 por time
    // Para brevidade e tamanho, similar ao 1v1, jogadores nas posições 200/arena.w-200 e 350/arena.w-350
    let players = [];
    let arena = {w: gameCanvas.width, h: gameCanvas.height};
    const groundY = arena.h - 100;
    const gravidade = 1;
    const speed = 6;
    let timerRound = 60 * 60;
    let vencedor = null;

    function criarPlayers() {
      players = [];
      currentSala.jogadores.slice(0,4).forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: idx < 2 ? 200 + idx*150 : arena.w - 200 - (idx-2)*150,
          y: groundY,
          w: 50,
          h: 90,
          vy: 0,
          noChao: true,
          atacando: false,
          vida: 100,
          cor: idx < 2 ? '#08f' : '#f00',
          dir: idx < 2 ? 1 : -1,
          velocidade: speed,
          ataqueCooldown: 0
        });
      });
    }
    criarPlayers();

    function desenha(){
      ctx.clearRect(0,0,arena.w,arena.h);
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,arena.w,arena.h);
      ctx.fillStyle = '#444';
      ctx.fillRect(0,groundY,arena.w,100);
      ctx.strokeStyle = '#aaa';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(arena.w/2,0);
      ctx.lineTo(arena.w/2,arena.h);
      ctx.stroke();

      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x-p.w/2, p.y-p.h, p.w, p.h);
        ctx.fillStyle = '#0f0';
        ctx.fillRect(p.x-p.w/2, p.y-p.h-15, p.w * (p.vida/100), 8);
        ctx.fillStyle = '#fff';
        ctx.font = '14px monospace';
        ctx.fillText(p.nome, p.x - p.w/2, p.y - p.h - 25);
      });

      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Tempo: ${Math.floor(timerRound/60)}s`, arena.w/2 - 60, 50);

      if(vencedor){
        ctx.fillStyle = '#ff0';
        ctx.font = '48px monospace';
        ctx.fillText(`${vencedor} venceu!`, arena.w/2 - 120, arena.h/2);
      }
    }

    function colidiuAtque(atacante, defensor){
      if(atacante.dir === 1){
        return (atacante.x + atacante.w/2 + 10 >= defensor.x - defensor.w/2) &&
          (atacante.x < defensor.x) &&
          (atacante.y >= defensor.y - defensor.h) &&
          (atacante.y <= defensor.y);
      } else {
        return (atacante.x - atacante.w/2 - 10 <= defensor.x + defensor.w/2) &&
          (atacante.x > defensor.x) &&
          (atacante.y >= defensor.y - defensor.h) &&
          (atacante.y <= defensor.y);
      }
    }

    function atualizarPlayers(){
      players.forEach(p => {
        if(p.ataqueCooldown > 0) p.ataqueCooldown--;
        if(p.bot){
          let alvos = players.filter(x => (p.cor !== x.cor) && (x.vida > 0));
          if(alvos.length === 0) return;
          let alvo = alvos[Math.floor(Math.random()*alvos.length)];
          let dx = alvo.x - p.x;
          if(Math.abs(dx) > 70){
            p.dir = dx > 0 ? 1 : -1;
            p.x += p.dir * p.velocidade;
          } else {
            if(p.ataqueCooldown === 0){
              p.atacando = true;
              p.ataqueCooldown = 60;
            } else {
              p.atacando = false;
            }
          }
        } else {
          if(p.id === PLAYER_ID){
            if(keys['arrowleft']) {
              p.x -= p.velocidade;
              p.dir = -1;
            }
            if(keys['arrowright']) {
              p.x += p.velocidade;
              p.dir = 1;
            }
            if(keys['arrowup'] && p.noChao) {
              p.vy = -18;
              p.noChao = false;
            }
            if(keys[' ']) {
              if(p.ataqueCooldown === 0){
                p.atacando = true;
                p.ataqueCooldown = 60;
              }
            }
          }
        }
        if(!p.noChao){
          p.vy += gravidade;
          p.y += p.vy;
          if(p.y >= groundY){
            p.y = groundY;
            p.noChao = true;
            p.vy = 0;
          }
        }
        p.x = Math.max(p.w/2, Math.min(arena.w - p.w/2, p.x));
      });

      // Dano
      players.forEach(atacante => {
        if(atacante.atacando){
          players.forEach(defensor => {
            if(defensor.cor !== atacante.cor && colidiuAtque(atacante, defensor)){
              defensor.vida -= 0.7;
              if(defensor.vida <= 0 && !vencedor){
                vencedor = atacante.cor === '#08f' ? 'Azul' : 'Vermelho';
                gameMessage.textContent = `${vencedor} venceu!`;
              }
            }
          });
          atacante.atacando = false;
        }
      });
    }

    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({
          id: p.id, x:p.x, y:p.y, vy:p.vy, noChao:p.noChao,
          atacando:p.atacando, vida:p.vida, dir:p.dir,
          ataqueCooldown: p.ataqueCooldown, cor:p.cor
        })),
        timerRound,
        vencedor
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y; p.vy = pj.vy;
          p.noChao = pj.noChao; p.atacando = pj.atacando;
          p.vida = pj.vida; p.dir = pj.dir; p.ataqueCooldown = pj.ataqueCooldown;
          p.cor = pj.cor;
        }
      });
      timerRound = e.timerRound;
      vencedor = e.vencedor;
    }

    function loop(){
      if(timerRound > 0 && !vencedor) timerRound--;
      atualizarPlayers();
      desenha();
      enviarEstado();
    }

    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => {
        currentSala = sala;
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 6) Corrida 1v1 --
  function initCorrida1v1(){
    // Corrida simples de 1 pista, 2 jogadores, obstáculos
    let players = [];
    let pista = {w: gameCanvas.width, h: gameCanvas.height};
    let timerCorrida = 60 * 60; // 60 segundos
    const speed = 5;
    const obstaculos = [];

    function criarPlayers(){
      players = [];
      currentSala.jogadores.slice(0,2).forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: 50,
          y: pista.h - 100 - idx * 60,
          w: 50,
          h: 40,
          velocidade: speed,
          velocidadeAtual: 0,
          cor: idx === 0 ? '#f00' : '#00f',
          pulando: false,
          vy: 0
        });
      });
    }

    function gerarObstaculos(){
      obstaculos.length = 0;
      for(let i = 0; i < 8; i++){
        obstaculos.push({
          x: 200 + i * 150,
          y: pista.h - 100,
          w: 40,
          h: 40
        });
      }
    }

    criarPlayers();
    gerarObstaculos();

    function desenha(){
      ctx.clearRect(0,0,pista.w,pista.h);
      ctx.fillStyle = '#88c';
      ctx.fillRect(0,0,pista.w,pista.h);
      // pista
      ctx.fillStyle = '#444';
      ctx.fillRect(0,pista.h - 100,pista.w, 100);

      // Obstaculos
      ctx.fillStyle = '#aaa';
      obstaculos.forEach(o => {
        ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
      });

      // Jogadores
      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x, p.y - p.h, p.w, p.h);
        ctx.fillStyle = '#000';
        ctx.fillText(p.nome, p.x, p.y - p.h - 10);
      });

      // Timer
      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Tempo: ${Math.floor(timerCorrida/60)}s`, pista.w/2 - 60, 40);
    }

    function colidiu(p, o){
      return (p.x + p.w > o.x && p.x < o.x + o.w && p.y > o.y - o.h && p.y - p.h < o.y);
    }

    function atualizarPlayers(){
      players.forEach(p => {
        if(p.bot){
          if(!p.pulando && Math.random() < 0.01){
            p.pulando = true;
            p.vy = -15;
          }
        } else {
          if(p.id === PLAYER_ID){
            if(keys[' ']){
              if(!p.pulando){
                p.pulando = true;
                p.vy = -15;
              }
            }
          }
        }
        if(p.pulando){
          p.vy += 1;
          p.y += p.vy;
          if(p.y >= pista.h - 100){
            p.y = pista.h - 100;
            p.pulando = false;
            p.vy = 0;
          }
        }
        p.x += p.velocidadeAtual;
        if(p.x > pista.w) p.x = 0;
        obstaculos.forEach(o => {
          if(colidiu(p,o)) p.x -= 3;
        });
      });
    }

    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({
          id:p.id, x:p.x, y:p.y, pulando:p.pulando, vy:p.vy, cor:p.cor
        })),
        timerCorrida
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y; p.pulando = pj.pulando; p.vy = pj.vy; p.cor = pj.cor;
        }
      });
      timerCorrida = e.timerCorrida;
    }

    function loop(){
      atualizarPlayers();
      desenha();
      enviarEstado();
      if(timerCorrida > 0) timerCorrida--;
    }

    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => {
        currentSala = sala;
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 7) Corrida 2v2 --
  function initCorrida2v2(){
    // Similar ao 1v1, 4 jogadores divididos em 2 equipes
    let players = [];
    let pista = {w: gameCanvas.width, h: gameCanvas.height};
    let timerCorrida = 60 * 60; // 60 segundos
    const speed = 5;
    const obstaculos = [];

    function criarPlayers(){
      players = [];
      currentSala.jogadores.slice(0,4).forEach((j, idx) => {
        players.push({
          id: j.id,
          nome: j.nome,
          bot: j.bot,
          x: 50,
          y: pista.h - 100 - (idx%2) * 60,
          w: 50,
          h: 40,
          velocidade: speed,
          velocidadeAtual: 0,
          cor: idx < 2 ? '#f00' : '#00f',
          pulando: false,
          vy: 0
        });
      });
    }

    function gerarObstaculos(){
      obstaculos.length = 0;
      for(let i = 0; i < 8; i++){
        obstaculos.push({
          x: 200 + i * 150,
          y: pista.h - 100,
          w: 40,
          h: 40
        });
      }
    }

    criarPlayers();
    gerarObstaculos();

    function desenha(){
      ctx.clearRect(0,0,pista.w,pista.h);
      ctx.fillStyle = '#88c';
      ctx.fillRect(0,0,pista.w,pista.h);
      ctx.fillStyle = '#444';
      ctx.fillRect(0,pista.h - 100,pista.w, 100);

      ctx.fillStyle = '#aaa';
      obstaculos.forEach(o => {
        ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
      });

      players.forEach(p => {
        ctx.fillStyle = p.cor;
        ctx.fillRect(p.x, p.y - p.h, p.w, p.h);
        ctx.fillStyle = '#000';
        ctx.fillText(p.nome, p.x, p.y - p.h - 10);
      });

      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Tempo: ${Math.floor(timerCorrida/60)}s`, pista.w/2 - 60, 40);
    }

    function colidiu(p, o){
      return (p.x + p.w > o.x && p.x < o.x + o.w && p.y > o.y - o.h && p.y - p.h < o.y);
    }

    function atualizarPlayers(){
      players.forEach(p => {
        if(p.bot){
          if(!p.pulando && Math.random() < 0.01){
            p.pulando = true;
            p.vy = -15;
          }
        } else {
          if(p.id === PLAYER_ID){
            if(keys[' ']){
              if(!p.pulando){
                p.pulando = true;
                p.vy = -15;
              }
            }
          }
        }
        if(p.pulando){
          p.vy += 1;
          p.y += p.vy;
          if(p.y >= pista.h - 100){
            p.y = pista.h - 100;
            p.pulando = false;
            p.vy = 0;
          }
        }
        p.x += p.velocidadeAtual;
        if(p.x > pista.w) p.x = 0;
        obstaculos.forEach(o => {
          if(colidiu(p,o)) p.x -= 3;
        });
      });
    }

    function enviarEstado(){
      if(!currentSala) return;
      currentSala.estadoJogo = {
        players: players.map(p => ({
          id:p.id, x:p.x, y:p.y, pulando:p.pulando, vy:p.vy, cor:p.cor
        })),
        timerCorrida
      };
      currentSala.ultimaAtividade = Date.now();
      salvarSalas();
    }

    function atualizarEstadoSala(){
      if(!currentSala || !currentSala.estadoJogo) return;
      const e = currentSala.estadoJogo;
      players.forEach(p => {
        let pj = e.players.find(x => x.id === p.id);
        if(pj){
          p.x = pj.x; p.y = pj.y; p.pulando = pj.pulando; p.vy = pj.vy; p.cor = pj.cor;
        }
      });
      timerCorrida = e.timerCorrida;
    }

    function loop(){
      atualizarPlayers();
      desenha();
      enviarEstado();
      if(timerCorrida > 0) timerCorrida--;
    }

    gameInstance = {
      cleanup: () => { clearInterval(gameLoopId); },
      onKeyDown: null,
      onKeyUp: null,
      onSalaAtualizada: (sala) => {
        currentSala = sala;
        atualizarEstadoSala();
      }
    };

    let gameLoopId = setInterval(loop, 1000/60);
  }

  // -- 8) Slot Machine --
  function initSlotMachine(){
    let reels = [
      ['🍒','🍋','🍊','🍉','⭐','7️⃣'],
      ['🍒','🍋','🍊','🍉','⭐','7️⃣'],
      ['🍒','🍋','🍊','🍉','⭐','7️⃣']
    ];
    let positions = [0,0,0];
    let spinning = false;
    let spinSpeed = [0,0,0];
    let spinTimeout = null;

    function desenha(){
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);

      ctx.font = '72px monospace';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#fff';

      for(let i=0; i<3; i++){
        let y = gameCanvas.height/2 + (i-1)*100;
        ctx.fillText(reels[i][positions[i]], gameCanvas.width/2, y);
      }

      ctx.font = '36px monospace';
      ctx.fillText('Pressione Espaço para girar', gameCanvas.width/2, gameCanvas.height - 50);
    }

    function spin(){
      if(spinning) return;
      spinning = true;
      spinSpeed = [20, 30, 40];
      let stops = [Math.floor(Math.random()*reels[0].length), Math.floor(Math.random()*reels[0].length), Math.floor(Math.random()*reels[0].length)];
      let count = 0;

      function step(){
        for(let i=0; i<3; i++){
          positions[i] = (positions[i] + spinSpeed[i]) % reels[i].length;
        }
        spinSpeed = spinSpeed.map(s => s * 0.9);
        desenha();
        count++;
        if(count > 60 && spinSpeed.every(s => s < 1)){
          positions = stops;
          spinning = false;
          clearInterval(spinTimeout);
          verificarResultado();
        }
      }
      spinTimeout = setInterval(step, 1000/30);
    }

    function verificarResultado(){
      if(positions[0] === positions[1] && positions[1] === positions[2]){
        gameMessage.textContent = 'Você ganhou!';
      } else {
        gameMessage.textContent = 'Tente novamente!';
      }
    }

    function loop(){
      desenha();
    }

    gameInstance = {
      cleanup: () => { if(spinTimeout) clearInterval(spinTimeout); },
      onKeyDown: (key) => {
        if(key === ' ') spin();
      },
      onKeyUp: null,
      onSalaAtualizada: null
    };

    let gameLoopId = setInterval(loop, 1000/30);
  }

  // -- 9) Quiz 1 --
  function initQuiz1(){
    let perguntas = [
      {q: 'Qual a capital de Portugal?', options: ['Lisboa','Porto','Coimbra','Braga'], a: 0},
      {q: 'Qual a maior montanha do mundo?', options: ['Everest','K2','Kangchenjunga','Lhotse'], a: 0},
      {q: 'Qual o elemento químico com símbolo O?', options: ['Oxigénio','Ouro','Osmio','Ouro Branco'], a: 0}
    ];
    let indice = 0;
    let pontuacao = 0;

    function desenha(){
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
      ctx.fillStyle = '#333';
      ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);

      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Pergunta ${indice+1}/${perguntas.length}`, 20, 40);
      ctx.fillText(perguntas[indice].q, 20, 80);

      perguntas[indice].options.forEach((opt,i) => {
        ctx.fillStyle = '#ccc';
        ctx.fillRect(20, 100 + i*50, 400, 40);
        ctx.fillStyle = '#000';
        ctx.fillText(opt, 30, 130 + i*50);
      });

      ctx.fillStyle = '#0f0';
      ctx.fillText(`Pontuação: ${pontuacao}`, 20, gameCanvas.height - 40);
    }

    function verificarClick(x,y){
      perguntas[indice].options.forEach((opt,i) => {
        let rx = 20;
        let ry = 100 + i*50;
        let rw = 400;
        let rh = 40;
        if(x >= rx && x <= rx+rw && y >= ry && y <= ry+rh){
          if(i === perguntas[indice].a){
            pontuacao++;
            gameMessage.textContent = 'Resposta correta!';
          } else {
            gameMessage.textContent = 'Resposta errada!';
          }
          indice++;
          if(indice >= perguntas.length){
            gameMessage.textContent += ' Quiz terminado!';
            indice = 0;
            pontuacao = 0;
          }
        }
      });
    }

    function loop(){
      desenha();
    }

    function onClick(x,y){
      verificarClick(x,y);
    }

    gameInstance = {
      cleanup: () => {},
      onKeyDown: null,
      onKeyUp: null,
      onClick,
      onSalaAtualizada: null
    };

    let gameLoopId = setInterval(loop, 1000/30);
  }

  // -- 10) Quiz 2 --
  function initQuiz2(){
    let perguntas = [
      {q: 'Quem pintou a Mona Lisa?', options: ['Da Vinci','Michelangelo','Raphael','Donatello'], a: 0},
      {q: 'Qual o maior planeta do sistema solar?', options: ['Júpiter','Saturno','Netuno','Marte'], a: 0},
      {q: 'Qual o país com maior população do mundo?', options: ['China','Índia','Estados Unidos','Brasil'], a: 0}
    ];
    let indice = 0;
    let pontuacao = 0;

    function desenha(){
      ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
      ctx.fillStyle = '#444';
      ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);

      ctx.fillStyle = '#fff';
      ctx.font = '28px monospace';
      ctx.fillText(`Pergunta ${indice+1}/${perguntas.length}`, 20, 40);
      ctx.fillText(perguntas[indice].q, 20, 80);

      perguntas[indice].options.forEach((opt,i) => {
        ctx.fillStyle = '#ccc';
        ctx.fillRect(20, 100 + i*50, 400, 40);
        ctx.fillStyle = '#000';
        ctx.fillText(opt, 30, 130 + i*50);
      });

      ctx.fillStyle = '#0f0';
      ctx.fillText(`Pontuação: ${pontuacao}`, 20, gameCanvas.height - 40);
    }

    function verificarClick(x,y){
      perguntas[indice].options.forEach((opt,i) => {
        let rx = 20;
        let ry = 100 + i*50;
        let rw = 400;
        let rh = 40;
        if(x >= rx && x <= rx+rw && y >= ry && y <= ry+rh){
          if(i === perguntas[indice].a){
            pontuacao++;
            gameMessage.textContent = 'Resposta correta!';
          } else {
            gameMessage.textContent = 'Resposta errada!';
          }
          indice++;
          if(indice >= perguntas.length){
            gameMessage.textContent += ' Quiz terminado!';
            indice = 0;
            pontuacao = 0;
          }
        }
      });
    }

    function loop(){
      desenha();
    }

    function onClick(x,y){
      verificarClick(x,y);
    }

    gameInstance = {
      cleanup: () => {},
      onKeyDown: null,
      onKeyUp: null,
      onClick,
      onSalaAtualizada: null
    };

    let gameLoopId = setInterval(loop, 1000/30);
  }

  // =================
  // MAIN INIT GAME
  // =================
  function iniciarJogo(){
    if(gameInstance && gameInstance.cleanup) gameInstance.cleanup();
    ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
    gameMessage.textContent = '';
    switch(currentGame){
      case 'futebol1v1': initFutebol1v1(); break;
      case 'lutarua1v1': initLutaRua1v1(); break;
      case 'lutarua2v2': initLutaRua2v2(); break;
      case 'corrida1v1': initCorrida1v1(); break;
      case 'corrida2v2': initCorrida2v2(); break;
      case 'slotmachine': initSlotMachine(); break;
      case 'quiz1': initQuiz1(); break;
      case 'quiz2': initQuiz2(); break;
      default:
        gameMessage.textContent = 'Jogo não disponível.';
        ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
        break;
    }
  }

  // =================
  // EVENTS
  // =================
  window.addEventListener('keydown', e => {
    if(gameInstance && gameInstance.onKeyDown) gameInstance.onKeyDown(e.key.toLowerCase());
  });
  window.addEventListener('keyup', e => {
    if(gameInstance && gameInstance.onKeyUp) gameInstance.onKeyUp(e.key.toLowerCase());
  });
  gameCanvas.addEventListener('click', e => {
    if(gameInstance && gameInstance.onClick) gameInstance.onClick(e.offsetX, e.offsetY);
  });

  // =================
  // UI CONTROLS
  // =================
  function mudarJogo(nome){
    if(gameInstance && gameInstance.cleanup) gameInstance.cleanup();
    currentGame = nome;
    iniciarJogo();
  }

  function buscarSala(){
    let codigo = prompt('Digite o código da sala:');
    if(!codigo) return alert('Código inválido!');
    let sala = salas.find(s => s.codigo === codigo);
    if(!sala) return alert('Sala não encontrada!');
    currentSala = sala;
    alert(`Entrou na sala: ${codigo}`);
    iniciarJogo();
  }

  function criarSala(){
    let codigo = Math.random().toString(36).substring(2,7).toUpperCase();
    currentSala = {codigo, jogadores: [], estadoJogo: null, ultimaAtividade: Date.now()};
    salas.push(currentSala);
    alert(`Sala criada: ${codigo}`);
    iniciarJogo();
  }

  // =================
  // START
  // =================
  window.onload = () => {
    mudarJogo('slotmachine'); // padrão
  };
  </script>
</body>
</html>
