import React, { useState, useRef } from "react";

const COLORS = [
  "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
  "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe",
  "#008080", "#e6beff", "#9a6324", "#fffac8", "#800000",
  "#aaffc3", "#808000", "#ffd8b1", "#000075", "#808080",
  "#000000", "#ffffff", "#b71c1c", "#4caf50", "#ffeb3b",
  "#ff5722", "#009688", "#2196f3", "#673ab7", "#ff4081"
];

// Map data with countries and paths (simplified shapes)
const MAPS = {
  world: {
    name: "World",
    countries: [
      { id: "usa", name: "USA", path: "M100,100 L200,100 L200,200 L100,200 Z" },
      { id: "canada", name: "Canada", path: "M100,50 L200,50 L200,90 L100,90 Z" },
      { id: "brazil", name: "Brazil", path: "M250,250 L350,250 L350,350 L250,350 Z" },
      { id: "argentina", name: "Argentina", path: "M270,360 L320,360 L320,410 L270,410 Z" },

      { id: "uk", name: "UK", path: "M400,100 L450,100 L450,150 L400,150 Z" },
      { id: "spain", name: "Spain", path: "M460,170 L510,170 L510,220 L460,220 Z" },
      { id: "portugal", name: "Portugal", path: "M440,180 L460,180 L460,210 L440,210 Z" },
      { id: "greece", name: "Greece", path: "M530,210 L560,210 L560,240 L530,240 Z" },
      { id: "poland", name: "Poland", path: "M560,130 L600,130 L600,170 L560,170 Z" },
      { id: "switzerland", name: "Switzerland", path: "M530,160 L560,160 L560,190 L530,190 Z" },
      { id: "czechia", name: "Czechia", path: "M570,150 L600,150 L600,180 L570,180 Z" },
      { id: "austria", name: "Austria", path: "M550,180 L580,180 L580,210 L550,210 Z" },
      { id: "russia", name: "Russia", path: "M600,50 L700,50 L700,150 L600,150 Z" },
      { id: "turkey", name: "Turkey", path: "M590,180 L630,180 L630,210 L590,210 Z" },
      { id: "syria", name: "Syria", path: "M630,210 L660,210 L660,240 L630,240 Z" },
      { id: "iraq", name: "Iraq", path: "M660,230 L690,230 L690,260 L660,260 Z" },

      { id: "morocco", name: "Morocco", path: "M460,130 L490,130 L490,160 L460,160 Z" },
      { id: "algeria", name: "Algeria", path: "M500,160 L530,160 L530,190 L500,190 Z" },
      { id: "libya", name: "Libya", path: "M540,160 L570,160 L570,190 L540,190 Z" },

      { id: "china", name: "China", path: "M720,150 L800,150 L800,250 L720,250 Z" },
      { id: "india", name: "India", path: "M750,260 L820,260 L820,310 L750,310 Z" },
    ],
  },
  europe: {
    name: "Europe",
    countries: [
      { id: "uk", name: "UK", path: "M400,100 L450,100 L450,150 L400,150 Z" },
      { id: "spain", name: "Spain", path: "M460,170 L510,170 L510,220 L460,220 Z" },
      { id: "portugal", name: "Portugal", path: "M440,180 L460,180 L460,210 L440,210 Z" },
      { id: "greece", name: "Greece", path: "M530,210 L560,210 L560,240 L530,240 Z" },
      { id: "poland", name: "Poland", path: "M560,130 L600,130 L600,170 L560,170 Z" },
      { id: "switzerland", name: "Switzerland", path: "M530,160 L560,160 L560,190 L530,190 Z" },
      { id: "czechia", name: "Czechia", path: "M570,150 L600,150 L600,180 L570,180 Z" },
      { id: "austria", name: "Austria", path: "M550,180 L580,180 L580,210 L550,210 Z" },
      { id: "russia", name: "Russia", path: "M600,50 L700,50 L700,150 L600,150 Z" },
      { id: "turkey", name: "Turkey", path: "M590,180 L630,180 L630,210 L590,210 Z" },
      { id: "morocco", name: "Morocco", path: "M460,130 L490,130 L490,160 L460,160 Z" },
      { id: "algeria", name: "Algeria", path: "M500,160 L530,160 L530,190 L500,190 Z" },
      { id: "libya", name: "Libya", path: "M540,160 L570,160 L570,190 L540,190 Z" },
    ],
  },
};

const REGIONS = [
  { id: "world", name: "World" },
  { id: "europe", name: "Europe" },
];

export default function App() {
  const [page, setPage] = useState("home"); // "home", "select", "editor"
  const [selectedRegion, setSelectedRegion] = useState("world");
  const [regionColors, setRegionColors] = useState({});
  const [selectedColor, setSelectedColor] = useState(COLORS[0]);
  const [colorSearch, setColorSearch] = useState("");
  const [legendItems, setLegendItems] = useState([]);
  const [zoom, setZoom] = useState(1);
  const [offset, setOffset] = useState({ x: 0, y: 0 });
  const [dragging, setDragging] = useState(false);
  const dragStart = useRef({ x: 0, y: 0 });
  const offsetStart = useRef({ x: 0, y: 0 });
  const svgRef = useRef(null);

  const countries = MAPS[selectedRegion].countries;

  // Pan & drag handlers
  function onMouseDown(e) {
    setDragging(true);
    dragStart.current = { x: e.clientX, y: e.clientY };
    offsetStart.current = { ...offset };
  }
  function onMouseMove(e) {
    if (!dragging) return;
    const dx = e.clientX - dragStart.current.x;
    const dy = e.clientY - dragStart.current.y;
    setOffset({ x: offsetStart.current.x + dx, y: offsetStart.current.y + dy });
  }
  function onMouseUp() {
    setDragging(false);
  }

  // Zoom controls
  function zoomIn() {
    setZoom((z) => Math.min(z + 0.2, 10));
  }
  function zoomOut() {
    setZoom((z) => Math.max(z - 0.2, 0.3));
  }
  function resetView() {
    setZoom(1);
    setOffset({ x: 0, y: 0 });
  }

  // Color a country on click
  function colorCountry(id) {
    setRegionColors((prev) => ({ ...prev, [id]: selectedColor }));
    // Add to legend if not exists
    if (!legendItems.some((l) => l.color === selectedColor)) {
      setLegendItems((prev) => [...prev, { color: selectedColor, label: "" }]);
    }
  }

  // Legend update
  function updateLegendLabel(i, label) {
    const newLegends = [...legendItems];
    newLegends[i].label = label;
    setLegendItems(newLegends);
  }
  function removeLegend(i) {
    setLegendItems((prev) => prev.filter((_, idx) => idx !== i));
  }

  // Export SVG to PNG
  function exportPNG() {
    if (!svgRef.current) return;
    const svg = svgRef.current;
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svg);
    const img = new Image();
    const svgBlob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = svg.clientWidth * 2;
      canvas.height = svg.clientHeight * 2;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      const pngUrl = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = pngUrl;
      a.download = "map.png";
      a.click();
    };
    img.src = url;
  }

  // Filter colors by search
  const filteredColors = COLORS.filter((c) =>
    c.toLowerCase().includes(colorSearch.toLowerCase())
  );

  // ========== PAGES ==========
  if (page === "home") {
    return (
      <div style={styles.container}>
        <h1 style={{ fontSize: 48, marginBottom: 8, fontWeight: "bold" }}>
          Map Creator
        </h1>
        <p style={{ fontSize: 18, maxWidth: 600, marginBottom: 24 }}>
          Create, color, and customize maps like a pro. Inspired by MapChart & Periphern.
        </p>
        <div style={{ marginBottom: 24 }}>
          <button style={styles.primaryButton} onClick={() => setPage("select")}>
            Create Map
          </button>
          <button style={styles.secondaryButton} onClick={() => alert("Login page placeholder")}>
            Login
          </button>
          <button style={styles.secondaryButton} onClick={() => alert("Register page placeholder")}>
            Create Account
          </button>
        </div>
        <section style={{ maxWidth: 600, textAlign: "left" }}>
          <h2>Tutorial</h2>
          <ol>
            <li>Click "Create Map" to start.</li>
            <li>Select the continent or country map.</li>
            <li>Color the countries using the color palette.</li>
            <li>Add legends to explain your colors.</li>
            <li>Export your finished map as PNG.</li>
          </ol>
        </section>
        <footer style={{ marginTop: 40, fontSize: 14, color: "#666" }}>
          Made by @tugamapper - Inspired by MapChart & Periphern.
        </footer>
      </div>
    );
  }

  if (page === "select") {
    return (
      <div style={styles.container}>
        <h1 style={{ fontSize: 36, marginBottom: 16 }}>Select Map</h1>
        <div style={{ marginBottom: 24 }}>
          {REGIONS.map((region) => (
            <button
              key={region.id}
              onClick={() => {
                setSelectedRegion(region.id);
                setRegionColors({});
                setLegendItems([]);
                setPage("editor");
                resetView();
              }}
              style={{
                ...styles.regionButton,
                backgroundColor: selectedRegion === region.id ? "#4363d8" : "#eee",
                color: selectedRegion === region.id ? "white" : "#333",
              }}
            >
              {region.name}
            </button>
          ))}
        </div>
        <button onClick={() => setPage("home")} style={styles.secondaryButton}>
          Back to Home
        </button>
        <footer style={{ marginTop: 40, fontSize: 14, color: "#666" }}>
          Made by @tugamapper - Inspired by MapChart & Periphern.
        </footer>
      </div>
    );
  }

  if (page === "editor") {
    return (
      <div style={{ ...styles.container, userSelect: "none" }}>
        <h1 style={{ marginBottom: 12 }}>{MAPS[selectedRegion].name} Map Editor</h1>

        <div style={styles.topBar}>
          <div>
            <label>
              Selected color:{" "}
              <input
                type="color"
                value={selectedColor}
                onChange={(e) => setSelectedColor(e.target.value)}
                style={{ width: 36, height: 36, verticalAlign: "middle", border: "none" }}
              />
            </label>
            <input
              type="text"
              placeholder="Search colors"
              value={colorSearch}
              onChange={(e) => setColorSearch(e.target.value)}
              style={{ marginLeft: 12, padding: "4px 8px" }}
            />
          </div>
          <button style={styles.primaryButton} onClick={() => addLegend()}>
            Add Legend
          </button>
          <button style={styles.secondaryButton} onClick={() => setPage("select")}>
            Back to Map Select
          </button>
          <button style={styles.secondaryButton} onClick={() => setPage("home")}>
            Home
          </button>
        </div>

        <div
          style={{
            border: "1px solid #ccc",
            width: "100%",
            height: 500,
            overflow: "hidden",
            marginBottom: 16,
            touchAction: "none",
            cursor: dragging ? "grabbing" : "grab",
            background: "#fafafa",
          }}
          onMouseDown={onMouseDown}
          onMouseMove={onMouseMove}
          onMouseUp={onMouseUp}
          onMouseLeave={onMouseUp}
        >
          <svg
            ref={svgRef}
            width="100%"
            height="100%"
            viewBox={`0 0 900 450`}
            style={{
              transform: `translate(${offset.x}px, ${offset.y}px) scale(${zoom})`,
              transformOrigin: "0 0",
              userSelect: "none",
            }}
          >
            {countries.map(({ id, name, path }) => (
              <path
                key={id}
                d={path}
                fill={regionColors[id] || "#eee"}
                stroke="#333"
                strokeWidth="1"
                style={{ cursor: "pointer" }}
                onClick={() => colorCountry(id)}
                title={name}
              />
            ))}
          </svg>
        </div>

        <div style={{ maxWidth: 600, marginBottom: 16 }}>
          <h3>Color Palette</h3>
          <div style={{ display: "flex", flexWrap: "wrap" }}>
            {filteredColors.map((color) => (
              <div
                key={color}
                onClick={() => setSelectedColor(color)}
                style={{
                  backgroundColor: color,
                  width: 28,
                  height: 28,
                  margin: 2,
                  borderRadius: 4,
                  border: color === selectedColor ? "3px solid black" : "1px solid #ccc",
                  cursor: "pointer",
                }}
                title={color}
              />
            ))}
            {filteredColors.length === 0 && <p>No colors found</p>}
          </div>
        </div>

        <div style={{ maxWidth: 600, marginBottom: 16 }}>
          <h3>Legends</h3>
          {legendItems.length === 0 && <p>No legends yet. Add one!</p>}
          {legendItems.map((item, i) => (
            <div key={i} style={{ display: "flex", alignItems: "center", marginBottom: 8 }}>
              <div
                style={{
                  backgroundColor: item.color,
                  width: 24,
                  height: 24,
                  borderRadius: 4,
                  border: "1px solid #333",
                  marginRight: 8,
                }}
              />
              <input
                type="text"
                placeholder="Legend label"
                value={item.label}
                onChange={(e) => updateLegendLabel(i, e.target.value)}
                style={{ flexGrow: 1, marginRight: 8 }}
              />
              <button onClick={() => removeLegend(i)} style={styles.dangerButton}>
                âœ•
              </button>
            </div>
          ))}
        </div>

        <div style={{ marginBottom: 24 }}>
          <button onClick={zoomIn} style={styles.secondaryButton}>
            Zoom In +
          </button>
          <button onClick={zoomOut} style={styles.secondaryButton}>
            Zoom Out -
          </button>
          <button onClick={resetView} style={styles.secondaryButton}>
            Reset View
          </button>
          <button onClick={exportPNG} style={styles.primaryButton}>
            Export PNG
          </button>
        </div>

        <footer style={{ fontSize: 14, color: "#666", marginTop: 40 }}>
          Made by @tugamapper - Inspired by MapChart & Periphern.
        </footer>
      </div>
    );
  }

  return null;
}

const styles = {
  container: {
    maxWidth: 900,
    margin: "auto",
    padding: 20,
    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
    textAlign: "center",
  },
  primaryButton: {
    backgroundColor: "#4363d8",
    color: "white",
    border: "none",
    padding: "10px 20px",
    fontSize: 16,
    borderRadius: 6,
    cursor: "pointer",
    margin: "0 6px",
  },
  secondaryButton: {
    backgroundColor: "#eee",
    border: "1px solid #ccc",
    padding: "10px 16px",
    fontSize: 14,
    borderRadius: 6,
    cursor: "pointer",
    margin: "0 6px",
  },
  dangerButton: {
    backgroundColor: "#e74c3c",
    border: "none",
    color: "white",
    borderRadius: 6,
    padding: "4px 8px",
    cursor: "pointer",
  },
  regionButton: {
    padding: "10px 16px",
    marginRight: 10,
    borderRadius: 6,
    cursor: "pointer",
    fontSize: 16,
    border: "none",
  },
};

// Add a function for adding a legend item (called on button click in editor)
function addLegend() {
  alert("Click on a country with the desired color first, then add legend.");
}
