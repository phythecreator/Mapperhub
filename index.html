<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geomarkr - Interactive Map Customizer</title>
<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React + ReactDOM UMD -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- react-simple-maps dependencies -->
<script src="https://cdn.jsdelivr.net/npm/d3-geo@3"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="https://cdn.jsdelivr.net/npm/react-simple-maps@3/dist/react-simple-maps.umd.production.min.js"></script>
<!-- FileSaver.js -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  body { margin: 0; }
  #root { height: 100vh; display: flex; flex-direction: column; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-white">
<div id="root"></div>

<script type="text/javascript">
const { useState, useEffect, useRef } = React;
const { ComposableMap, Geographies, Geography } = window['react-simple-maps'];
const topojson = window.topojson;
const saveAs = window.saveAs;

const CONTINENTS = {
  World: 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json',
  Europe: 'https://cdn.jsdelivr.net/npm/world-atlas@2/continent/europe.json',
  Africa: 'https://cdn.jsdelivr.net/npm/world-atlas@2/continent/africa.json',
  Asia: 'https://cdn.jsdelivr.net/npm/world-atlas@2/continent/asia.json',
  Americas: 'https://cdn.jsdelivr.net/npm/world-atlas@2/continent/americas.json',
  Oceania: 'https://cdn.jsdelivr.net/npm/world-atlas@2/continent/oceania.json',
};
const COUNTRIES_DETAIL = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';

function App() {
  const [continent, setContinent] = useState('World');
  const [geoData, setGeoData] = useState(null);
  const [detail, setDetail] = useState(false);
  const [paintedRegions, setPaintedRegions] = useState({});
  const [color, setColor] = useState('#3b82f6');
  const [bgImage, setBgImage] = useState(null);

  const svgRef = useRef();

  useEffect(() => {
    const url = detail && continent !== 'World' ? COUNTRIES_DETAIL : CONTINENTS[continent];
    fetch(url)
      .then(res => res.json())
      .then(data => {
        const objName = Object.keys(data.objects)[0];
        const geojson = topojson.feature(data, data.objects[objName]);
        setGeoData(geojson);
        setPaintedRegions({});
      })
      .catch(console.error);
  }, [continent, detail]);

  function onRegionClick(geo) {
    const id = geo.id || geo.properties.iso_a3 || geo.properties.name;
    setPaintedRegions(prev => {
      const copy = { ...prev };
      if (copy[id] === color) delete copy[id];
      else copy[id] = color;
      return copy;
    });
  }

  function exportSVG() {
    if (!svgRef.current) return;
    const svgElement = svgRef.current.querySelector('svg');
    if (!svgElement) return;
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svgElement);
    const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
    saveAs(blob, 'geomarkr-map.svg');
  }

  function exportPNG() {
    if (!svgRef.current) return;
    const svgElement = svgRef.current.querySelector('svg');
    if (!svgElement) return;
    const xml = new XMLSerializer().serializeToString(svgElement);
    const svg64 = btoa(unescape(encodeURIComponent(xml)));
    const b64Start = 'data:image/svg+xml;base64,';
    const image64 = b64Start + svg64;

    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = svgElement.clientWidth * 2;
      canvas.height = svgElement.clientHeight * 2;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        saveAs(blob, 'geomarkr-map.png');
      });
    };
    img.src = image64;
  }

  function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => setBgImage(reader.result);
    reader.readAsDataURL(file);
  }

  return React.createElement('div', { className: 'flex flex-col min-h-screen' },
    // Header
    React.createElement('header', { className: 'flex flex-col md:flex-row md:justify-between items-center bg-gradient-to-r from-blue-700 to-indigo-700 text-white p-5 gap-4 select-none' },
      React.createElement('h1', { className: 'text-3xl font-extrabold tracking-wide' }, 'Geomarkr'),
      React.createElement('div', { className: 'flex flex-wrap gap-3 items-center' },
        React.createElement('select', {
          'aria-label': 'Select Continent',
          className: 'rounded px-3 py-2 text-gray-900',
          value: continent,
          onChange: e => setContinent(e.target.value)
        }, Object.keys(CONTINENTS).map(c =>
          React.createElement('option', { key: c, value: c }, c)
        )),
        React.createElement('label', { className: 'flex items-center gap-2 cursor-pointer' },
          React.createElement('input', {
            type: 'checkbox',
            checked: detail,
            onChange: e => setDetail(e.target.checked),
            className: 'rounded'
          }),
          React.createElement('span', null, 'Show Detail')
        ),
        React.createElement('input', {
          type: 'color',
          'aria-label': 'Pick color',
          value: color,
          onChange: e => setColor(e.target.value),
          className: 'w-10 h-10 rounded cursor-pointer border border-gray-300'
        }),
        React.createElement('label', {
          className: 'cursor-pointer bg-white text-gray-900 rounded px-3 py-2 border border-gray-300 hover:bg-gray-100'
        }, 'Upload Background',
          React.createElement('input', {
            type: 'file',
            accept: 'image/*',
            onChange: handleImageUpload,
            className: 'hidden'
          })
        ),
        React.createElement('button', {
          onClick: exportSVG,
          className: 'bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 transition',
          title: 'Export SVG'
        }, 'Export SVG'),
        React.createElement('button', {
          onClick: exportPNG,
          className: 'bg-green-600 px-4 py-2 rounded hover:bg-green-700 transition',
          title: 'Export PNG'
        }, 'Export PNG')
      )
    ),
    // Main container
    React.createElement('main', { className: 'flex-grow flex justify-center items-center p-4 bg-gray-50 dark:bg-gray-900' },
      React.createElement('div', {
        ref: svgRef,
        className: 'relative w-full max-w-[1000px] h-[600px] rounded shadow-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden'
      },
        bgImage && React.createElement('img', {
          src: bgImage,
          alt: 'Background',
          className: 'absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none'
        }),
        geoData ? React.createElement(ComposableMap, {
          width: 1000,
          height: 600,
          projectionConfig: { scale: 150 },
          style: { width: '100%', height: '100%' }
        },
          React.createElement(Geographies, { geography: geoData }, ({ geographies }) =>
            geographies.map(geo => {
              const id = geo.id || geo.properties.iso_a3 || geo.properties.name;
              const fill = paintedRegions[id] || '#DDD';
              return React.createElement(Geography, {
                key: id,
                geography: geo,
                onClick: () => onRegionClick(geo),
                style: {
                  default: {
                    fill,
                    stroke: '#555',
                    strokeWidth: 0.7,
                    outline: 'none',
                    cursor: 'pointer',
                    transition: 'fill 0.3s',
                  },
                  hover: {
                    fill: '#7777ff',
                    stroke: '#222',
                    strokeWidth: 1,
                    cursor: 'pointer',
                  },
                  pressed: {
                    fill: '#5555ff',
                    stroke: '#111',
                    strokeWidth: 1,
                  }
                }
              });
            })
          )
        ) : React.createElement('p', { className: 'text-center mt-40' }, 'Loading map data...')
      )
    ),
    // Footer
    React.createElement('footer', { className: 'p-4 text-center text-sm text-gray-600 dark:text-gray-400 select-none' },
      `Â© ${new Date().getFullYear()} Geomarkr. All rights reserved.`
    )
  );
}

const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(React.createElement(App));
</script>

</body>
</html>
