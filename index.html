import React, { useState, useEffect, useRef } from "react";

// ---- MOCK MAP DATA (Replace with your real SVG path data for continents & countries) ----
const MAPS = [
  { id: "world", name: "World Map" },
  { id: "africa", name: "Africa" },
  { id: "europe", name: "Europe" },
  { id: "asia", name: "Asia" },
  { id: "usa", name: "USA" },
  { id: "brazil", name: "Brazil" },
];

// Dummy region data structure per map for demonstration
const MAP_DATA = {
  world: {
    regions: [
      { id: "na", name: "North America", path: "M10,10 L100,10 L100,100 L10,100 Z" },
      { id: "sa", name: "South America", path: "M110,110 L200,110 L200,200 L110,200 Z" },
      { id: "eu", name: "Europe", path: "M210,10 L300,10 L300,100 L210,100 Z" },
      // Add more regions
    ],
  },
  africa: {
    regions: [
      { id: "af", name: "Africa Region", path: "M10,10 L100,10 L100,100 L10,100 Z" },
      // More regions
    ],
  },
  // Add others similarly
};

// Expanded colors array
const COLORS = [
  "#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5",
  "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4caf50",
  "#8bc34a", "#cddc39", "#ffeb3b", "#ffc107", "#ff9800",
  "#ff5722", "#795548", "#607d8b", "#000000", "#ffffff",
  "#b71c1c", "#880e4f", "#4a148c", "#311b92", "#1a237e",
  "#0d47a1", "#01579b", "#006064", "#004d40", "#1b5e20"
];

// Constants for SVG canvas size
const WIDTH = 800;
const HEIGHT = 600;

function Geomarkr() {
  // State for navigation
  const [page, setPage] = useState("home"); // home, register, chooseMap, editor, about

  // For map selection
  const [selectedMapId, setSelectedMapId] = useState(null);

  // Editor states
  const [mapData, setMapData] = useState(null);
  const [regionColors, setRegionColors] = useState({});
  const [selectedColor, setSelectedColor] = useState(COLORS[0]);

  // Search term for filtering regions
  const [searchTerm, setSearchTerm] = useState("");

  // Zoom and pan states
  const [zoom, setZoom] = useState(1);
  const [offset, setOffset] = useState({ x: 0, y: 0 });
  const [dragging, setDragging] = useState(false);
  const dragStart = useRef({ x: 0, y: 0 });
  const offsetStart = useRef({ x: 0, y: 0 });

  // SVG ref for export
  const svgRef = useRef(null);

  // Loading state
  const [loading, setLoading] = useState(false);

  // When map changes, load new map data
  useEffect(() => {
    if (!selectedMapId) return;
    setLoading(true);
    // Simulate fetch with timeout
    setTimeout(() => {
      setMapData(MAP_DATA[selectedMapId]);
      setRegionColors({});
      setZoom(1);
      setOffset({ x: 0, y: 0 });
      setLoading(false);
    }, 300);
  }, [selectedMapId]);

  // Mouse event handlers for panning
  function onMouseDown(e) {
    setDragging(true);
    dragStart.current = { x: e.clientX, y: e.clientY };
    offsetStart.current = { ...offset };
  }
  function onMouseMove(e) {
    if (!dragging) return;
    const dx = e.clientX - dragStart.current.x;
    const dy = e.clientY - dragStart.current.y;
    setOffset({ x: offsetStart.current.x + dx, y: offsetStart.current.y + dy });
  }
  function onMouseUp() {
    setDragging(false);
  }

  // Handle region click to paint color
  function onRegionClick(regionId) {
    setRegionColors((prev) => ({
      ...prev,
      [regionId]: selectedColor,
    }));
  }

  // Filter regions based on search
  const filteredRegions = mapData?.regions.filter(r =>
    r.name.toLowerCase().includes(searchTerm.toLowerCase())
  ) || [];

  // Export functions
  function exportPNG() {
    if (!svgRef.current) return;
    const svg = svgRef.current;
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svg);

    // Convert SVG to PNG using canvas
    const img = new Image();
    const svgBlob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);

    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = WIDTH;
      canvas.height = HEIGHT;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#222"; // background fill
      ctx.fillRect(0, 0, WIDTH, HEIGHT);
      ctx.drawImage(img, 0, 0, WIDTH, HEIGHT);
      URL.revokeObjectURL(url);

      canvas.toBlob(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${selectedMapId || "map"}-geomarkr.png`;
        a.click();
      });
    };
    img.src = url;
  }

  function exportSVG() {
    if (!svgRef.current) return;
    const svg = svgRef.current;
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svg);

    // Add XML declaration and namespace if missing
    if (!source.match(/^<\?xml/)) {
      source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
    }
    if (!source.includes('xmlns="http://www.w3.org/2000/svg"')) {
      source = source.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
    }

    const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `${selectedMapId || "map"}-geomarkr.svg`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // UI COMPONENTS:

  // Color palette with more colors
  function ColorPalette({ colors, selected, onSelect }) {
    return (
      <div className="flex flex-wrap gap-2 max-w-md justify-center">
        {colors.map((color, i) => (
          <button
            key={i}
            className="w-8 h-8 rounded-full border-2 focus:outline-none transition-transform hover:scale-110"
            style={{
              backgroundColor: color,
              borderColor: selected === color ? "#fff" : "transparent",
              boxShadow: selected === color ? "0 0 6px white" : "none",
            }}
            aria-label={`Select color ${color}`}
            onClick={() => onSelect(color)}
          />
        ))}
      </div>
    );
  }

  // Map selection list component
  function MapSelector({ maps, selectedId, onSelect }) {
    return (
      <div className="flex flex-wrap gap-3 max-w-xl justify-center">
        {maps.map(m => (
          <button
            key={m.id}
            onClick={() => onSelect(m.id)}
            className={`px-4 py-2 rounded-md font-semibold transition-colors ${
              selectedId === m.id
                ? "bg-indigo-600 text-white"
                : "bg-gray-700 text-gray-300 hover:bg-indigo-500 hover:text-white"
            }`}
            aria-label={`Select map ${m.name}`}
          >
            {m.name}
          </button>
        ))}
      </div>
    );
  }

  // ------------------ PAGE RENDERS --------------------

  if (page === "home") {
    return (
      <main className="flex flex-col items-center justify-center min-h-screen p-6 gap-12 bg-gradient-to-tr from-indigo-900 via-purple-900 to-indigo-900 text-white">
        <h1 className="text-6xl font-extrabold select-none">Geomarkr</h1>
        <p className="max-w-xl text-center text-xl font-light">
          Welcome to Geomarkr! Create and customize maps of continents and countries with ease.
          No login required to start editing your maps instantly.
        </p>
        <div className="flex flex-col sm:flex-row gap-6">
          <button
            className="px-10 py-4 bg-indigo-600 rounded-lg font-semibold hover:bg-indigo-700 transition"
            onClick={() => setPage("register")}
            aria-label="Create an account"
          >
            Create Account
          </button>
          <button
            className="px-10 py-4 border border-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white font-semibold transition"
            onClick={() => setPage("chooseMap")}
            aria-label="Choose a map to edit"
          >
            Choose Map
          </button>
        </div>
        <footer className="mt-20 text-sm text-gray-400 select-none">
          &copy; 2025 Geomarkr. All rights reserved.
        </footer>
      </main>
    );
  }

  if (page === "register") {
    return (
      <main className="flex flex-col items-center justify-center min-h-screen p-6 gap-8 bg-gray-900 text-white">
        <h2 className="text-5xl font-bold select-none">Create Your Account</h2>
        <p className="max-w-lg text-center mb-6">
          For now, this is just a placeholder. No account is needed to create and edit maps.
          You can start immediately without registering.
        </p>
        <button
          className="px-8 py-3 bg-indigo-600 rounded hover:bg-indigo-700 font-semibold transition"
          onClick={() => setPage("home")}
          aria-label="Back to home"
        >
          Back to Home
        </button>
      </main>
    );
  }

  if (page === "chooseMap") {
    return (
      <main className="flex flex-col items-center min-h-screen p-6 gap-6 bg-gray-900 text-white">
        <h2 className="text-4xl font-extrabold select-none mb-4">Choose Your Map</h2>
        <MapSelector maps={MAPS} selectedId={selectedMapId} onSelect={setSelectedMapId} />
        <div className="flex gap-6 mt-6">
          <button
            onClick={() => selectedMapId && setPage("editor")}
            disabled={!selectedMapId}
            className={`px-10 py-3 rounded-lg font-semibold transition ${
              selectedMapId
                ? "bg-indigo-600 hover:bg-indigo-700"
                : "bg-gray-700 cursor-not-allowed"
            }`}
            aria-label="Open editor with selected map"
          >
            Open Editor
          </button>
          <button
            onClick={() => setPage("home")}
            className="px-10 py-3 border border-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white font-semibold transition"
            aria-label="Back to home"
          >
            Cancel
          </button>
        </div>
      </main>
    );
  }

  if (page === "editor") {
    return (
      <main
        className="flex flex-col items-center p-4 bg-gray-900 min-h-screen gap-4 relative select-none"
        onMouseMove={onMouseMove}
        onMouseUp={onMouseUp}
        onMouseLeave={onMouseUp}
      >
        <header className="flex flex-wrap justify-between items-center w-full max-w-7xl mb-4 gap-4">
          <h2 className="text-3xl font-bold select-none">
            Editing Map:{" "}
            <span className="text-indigo-400">
              {MAPS.find((m) => m.id === selectedMapId)?.name || "Unknown"}
            </span>
          </h2>

          <div className="flex gap-3 flex-wrap justify-center">
            <button
              onClick={() => setPage("chooseMap")}
              className="px-4 py-2 border border-gray-500 rounded hover:bg-gray-600 hover:text-white transition"
              aria-label="Back to map selection"
            >
              Back to Maps
            </button>
            <button
              onClick={() => {
                setRegionColors({});
                setZoom(1);
                setOffset({ x: 0, y: 0 });
                setSearchTerm("");
              }}
              className="px-4 py-2 border border-indigo-600 rounded hover:bg-indigo-600 hover:text-white transition"
              aria-label="Reset all changes"
            >
              Reset
            </button>
            <button
              onClick={exportPNG}
              className="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-700 transition"
              aria-label="Export map as PNG"
            >
              Export PNG
            </button>
            <button
              onClick={exportSVG}
              className="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-700 transition"
              aria-label="Export map as SVG"
            >
              Export SVG
            </button>
          </div>
        </header>

        {/* Controls */}
        <section className="flex flex-wrap gap-6 justify-center max-w-7xl w-full mb-4">
          <div className="flex flex-col gap-2 items-center">
            <label htmlFor="colorPalette" className="font-semibold mb-1 text-gray-200 select-none">
              Select Color
            </label>
            <ColorPalette colors={COLORS} selected={selectedColor} onSelect={setSelectedColor} />
          </div>

          <div className="flex flex-col gap-1 max-w-sm w-full">
            <label htmlFor="searchBox" className="font-semibold text-gray-200 select-none">
              Search Country/Region
            </label>
            <input
              id="searchBox"
              type="search"
              className="rounded-md px-3 py-2 text-black w-full focus:outline-indigo-500"
              placeholder="Type to filter countries"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              aria-label="Search countries or regions"
            />
          </div>

          <div className="flex flex-col items-center gap-2 select-none">
            <label className="font-semibold text-gray-200">Zoom</label>
            <div className="flex items-center gap-2">
              <button
                aria-label="Zoom out"
                className="bg-gray-700 px-3 py-1 rounded hover:bg-gray-600 transition"
                onClick={() => setZoom((z) => Math.max(0.3, z - 0.2))}
              >
                −
              </button>
              <span
                aria-live="polite"
                aria-atomic="true"
                className="w-12 text-center select-text"
              >
                {zoom.toFixed(2)}×
              </span>
              <button
                aria-label="Zoom in"
                className="bg-gray-700 px-3 py-1 rounded hover:bg-gray-600 transition"
                onClick={() => setZoom((z) => Math.min(10, z + 0.2))}
              >
                +
              </button>
            </div>
          </div>
        </section>

        {/* Loading message */}
        {loading && (
          <div className="text-lg text-indigo-400 my-12 select-none">Loading map data...</div>
        )}

        {/* Map SVG container */}
        {!loading && (
          <div
            className={`overflow-hidden rounded-lg shadow-lg bg-gray-800 border border-gray-700 select-none`}
            style={{ width: WIDTH, height: HEIGHT, cursor: dragging ? "grabbing" : "grab" }}
            onMouseDown={onMouseDown}
          >
            <svg
              ref={svgRef}
              width={WIDTH}
              height={HEIGHT}
              style={{
                transform: `translate(${offset.x}px, ${offset.y}px) scale(${zoom})`,
                transformOrigin: "0 0",
                userSelect: "none",
                touchAction: "none",
                display: "block",
              }}
              aria-label="Editable map"
              role="img"
              onClick={(e) => {
                // Only allow clicks on paths to color them
                if (e.target.tagName === "path" && e.target.dataset.regionId) {
                  const id = e.target.dataset.regionId;
                  onRegionClick(id);
                }
              }}
            >
              {filteredRegions.map((region) => (
                <path
                  key={region.id}
                  data-region-id={region.id}
                  d={region.path}
                  fill={regionColors[region.id] || "#444"}
                  stroke="#222"
                  strokeWidth="0.5"
                  className="transition-colors duration-200 cursor-pointer"
                  aria-label={`Region ${region.name}`}
                  tabIndex={0}
                  onKeyDown={(ev) => {
                    // Allow coloring regions with keyboard (Enter or Space)
                    if ((ev.key === "Enter" || ev.key === " ") && region.id) {
                      ev.preventDefault();
                      onRegionClick(region.id);
                    }
                  }}
                />
              ))}
            </svg>
          </div>
        )}
      </main>
    );
  }

  return null;
}

export default Geomarkr;
