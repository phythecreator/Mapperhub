<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geomarkr - Interactive Map Customizer</title>

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- D3 + topojson -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <!-- react-simple-maps -->
  <script src="https://cdn.jsdelivr.net/npm/react-simple-maps@3.0.0/dist/react-simple-maps.umd.production.min.js"></script>
  <!-- FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root {
      margin:0; padding:0; height:100%;
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    body.dark {
      background-color: #111827; /* Tailwind gray-900 */
      color: #f9fafb; /* Tailwind gray-50 */
    }
    #root {
      display:flex;
      flex-direction: column;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    svg {
      user-select:none;
    }
    .btn {
      @apply px-4 py-2 rounded text-white cursor-pointer transition duration-150;
    }
    .btn-blue { background-color: #3b82f6; }
    .btn-blue:hover { background-color: #2563eb; }
    .btn-green { background-color: #10b981; }
    .btn-green:hover { background-color: #059669; }
    .btn-red { background-color: #ef4444; }
    .btn-red:hover { background-color: #dc2626; }
  </style>
</head>
<body class="dark">
  <div id="root"></div>

  <script type="text/javascript">
    (() => {
      const { useState, useEffect, useRef } = React;
      const { ComposableMap, Geographies, Geography, ZoomableGroup } = window['react-simple-maps'];
      const topojson = window.topojson;
      const saveAs = window.saveAs;

      // Map topojson URLs (110m resolution for performance)
      const MAPS = {
        World: "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json",
        Africa: "https://cdn.jsdelivr.net/npm/world-atlas@2/continent/africa.json",
        Asia: "https://cdn.jsdelivr.net/npm/world-atlas@2/continent/asia.json",
        Europe: "https://cdn.jsdelivr.net/npm/world-atlas@2/continent/europe.json",
        Americas: "https://cdn.jsdelivr.net/npm/world-atlas@2/continent/americas.json",
        Oceania: "https://cdn.jsdelivr.net/npm/world-atlas@2/continent/oceania.json"
      };

      // Load and parse topojson to geojson
      async function loadGeoJSON(url) {
        const response = await fetch(url);
        const topo = await response.json();
        const objName = Object.keys(topo.objects)[0];
        return topojson.feature(topo, topo.objects[objName]);
      }

      function App() {
        // State variables
        const [continent, setContinent] = useState("World");
        const [geoData, setGeoData] = useState(null);
        const [paintedRegions, setPaintedRegions] = useState({});
        const [selectedColor, setSelectedColor] = useState("#3b82f6");
        const [bgImage, setBgImage] = useState(null);
        const [zoom, setZoom] = useState(1);
        const [center, setCenter] = useState([0, 20]);
        const svgContainerRef = useRef(null);

        // Load map data when continent changes
        useEffect(() => {
          loadGeoJSON(MAPS[continent]).then(data => {
            setGeoData(data);
            setPaintedRegions({});
            setZoom(1);
            setCenter([0,20]);
          }).catch(err => alert("Error loading map data: " + err));
        }, [continent]);

        // Paint or unpaint region on click
        function handleRegionClick(geo) {
          const id = geo.id || geo.properties.iso_a3 || geo.properties.name;
          setPaintedRegions(prev => {
            const newPainted = {...prev};
            if(newPainted[id] === selectedColor) {
              delete newPainted[id];
            } else {
              newPainted[id] = selectedColor;
            }
            return newPainted;
          });
        }

        // Handle background image upload
        function handleBgUpload(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => setBgImage(reader.result);
          reader.readAsDataURL(file);
        }

        // Clear all painted regions
        function clearPainting() {
          setPaintedRegions({});
        }

        // Reset zoom & center
        function resetView() {
          setZoom(1);
          setCenter([0,20]);
        }

        // Export SVG map with painted regions and background
        function exportSVG() {
          if (!svgContainerRef.current) return;
          const svg = svgContainerRef.current.querySelector("svg");
          if (!svg) return;
          // Clone and inline styles
          const clone = svg.cloneNode(true);
          // Serialize
          const serializer = new XMLSerializer();
          const source = serializer.serializeToString(clone);
          // Create blob and save
          const blob = new Blob([source], {type:"image/svg+xml;charset=utf-8"});
          saveAs(blob, "geomarkr-map.svg");
        }

        // Export PNG by drawing SVG on Canvas
        function exportPNG() {
          if (!svgContainerRef.current) return;
          const svg = svgContainerRef.current.querySelector("svg");
          if (!svg) return;

          const xml = new XMLSerializer().serializeToString(svg);
          const svg64 = btoa(unescape(encodeURIComponent(xml)));
          const image64 = 'data:image/svg+xml;base64,' + svg64;

          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = svg.clientWidth * 3; // 3x for high quality
            canvas.height = svg.clientHeight * 3;
            const ctx = canvas.getContext("2d");
            ctx.scale(3, 3);
            ctx.drawImage(img, 0, 0);
            canvas.toBlob(blob => {
              saveAs(blob, "geomarkr-map.png");
            });
          };
          img.onerror = () => alert("Failed to load SVG as image for PNG export.");
          img.src = image64;
        }

        // Zoom handlers
        function zoomIn() {
          setZoom(z => Math.min(8, z + 0.5));
        }
        function zoomOut() {
          setZoom(z => Math.max(1, z - 0.5));
        }

        return (
          React.createElement("div", {className:"flex flex-col h-full"},
            // HEADER
            React.createElement("header", {className:"flex flex-col md:flex-row items-center justify-between p-5 bg-gradient-to-r from-blue-700 to-indigo-700 text-white select-none"},
              React.createElement("h1", {className:"text-3xl font-extrabold tracking-wide mb-3 md:mb-0"}, "Geomarkr"),
              React.createElement("div", {className:"flex flex-wrap items-center gap-3"},
                React.createElement("select", {
                  className:"rounded px-3 py-2 text-gray-900",
                  value: continent,
                  onChange: e => setContinent(e.target.value),
                  title: "Select Continent"
                }, Object.keys(MAPS).map(c =>
                  React.createElement("option", {key:c, value:c}, c)
                )),
                React.createElement("input", {
                  type:"color",
                  title:"Select paint color",
                  className:"w-10 h-10 rounded border border-gray-300 cursor-pointer",
                  value: selectedColor,
                  onChange: e => setSelectedColor(e.target.value)
                }),
                React.createElement("label", {
                  className:"cursor-pointer bg-white text-gray-900 rounded px-3 py-2 border border-gray-300 hover:bg-gray-100"
                }, "Upload Background",
                  React.createElement("input", {
                    type:"file",
                    accept:"image/*",
                    className:"hidden",
                    onChange: handleBgUpload
                  })
                ),
                React.createElement("button", {
                  className:"btn btn-blue",
                  onClick: exportSVG,
                  title:"Export as SVG"
                }, "Export SVG"),
                React.createElement("button", {
                  className:"btn btn-green",
                  onClick: exportPNG,
                  title:"Export as PNG"
                }, "Export PNG"),
                React.createElement("button", {
                  className:"btn btn-red",
                  onClick: clearPainting,
                  title:"Clear all painted regions"
                }, "Clear Painting"),
                React.createElement("button", {
                  className:"btn btn-blue",
                  onClick: zoomIn,
                  title:"Zoom In"
                }, "+"),
                React.createElement("button", {
                  className:"btn btn-blue",
                  onClick: zoomOut,
                  title:"Zoom Out"
                }, "−"),
                React.createElement("button", {
                  className:"btn btn-blue",
                  onClick: resetView,
                  title:"Reset Zoom and Center"
                }, "Reset")
              )
            ),
            // MAIN MAP AREA
            React.createElement("main", {
              ref: svgContainerRef,
              className:"flex-grow flex justify-center items-center p-4 bg-white dark:bg-gray-800 relative overflow-hidden"
            },
              bgImage && React.createElement("img", {
                src: bgImage,
                alt:"Background",
                className:"absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none select-none"
              }),
              geoData
              ? React.createElement(ComposableMap, {
                  width: 1000,
                  height: 600,
                  projectionConfig: { scale: 150 },
                  style: { width: "100%", height: "100%", maxWidth:"1000px", maxHeight:"600px" }
                },
                React.createElement(ZoomableGroup, {
                  zoom: zoom,
                  center: center,
                  onMoveEnd: ({ zoom: z, coordinates }) => {
                    setZoom(z);
                    setCenter(coordinates);
                  },
                  maxZoom: 8,
                  minZoom: 1
                },
                  React.createElement(Geographies, { geography: geoData }, ({ geographies }) =>
                    geographies.map(geo => {
                      const id = geo.id || geo.properties.iso_a3 || geo.properties.name;
                      const fillColor = paintedRegions[id] || "#DDD";
                      return React.createElement(Geography, {
                        key: id,
                        geography: geo,
                        onClick: () => handleRegionClick(geo),
                        style: {
                          default: { fill: fillColor, stroke: "#666", strokeWidth: 0.5, cursor: "pointer", transition:"fill 0.3s" },
                          hover: { fill: "#f59e0b", stroke: "#444", strokeWidth: 1 },
                          pressed: { fill: "#b45309", stroke: "#222", strokeWidth: 1 }
                        }
                      });
                    })
                  )
                ))
              : React.createElement("p", {className:"text-center text-gray-600 dark:text-gray-400"}, "Loading map data...")
            ),
            // FOOTER
            React.createElement("footer", {className:"p-3 text-center text-sm text-gray-500 dark:text-gray-400 select-none"},
              "Geomarkr - Interactive Map Customizer — Made with React & react-simple-maps"
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    })();
  </script>
</body>
</html>
