import React, { useState, useEffect, useRef } from "react";

// Sample map data - these are simplified SVG path placeholders
const MAPS = {
  continents: [
    { id: "africa", name: "Africa", path: "M10 80 L90 80 L90 90 L10 90 Z" },
    { id: "asia", name: "Asia", path: "M20 10 L80 10 L80 70 L20 70 Z" },
    { id: "europe", name: "Europe", path: "M40 20 L60 20 L60 50 L40 50 Z" },
  ],
  countries: [
    { id: "brazil", name: "Brazil", path: "M30 60 L70 60 L70 80 L30 80 Z" },
    { id: "usa", name: "USA", path: "M10 10 L30 10 L30 40 L10 40 Z" },
    { id: "china", name: "China", path: "M50 30 L70 30 L70 50 L50 50 Z" },
  ],
};

const COLORS = [
  "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4",
  "#46f0f0", "#f032e6", "#bcf60c", "#fabebe", "#008080", "#e6beff",
  "#9a6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1",
  "#000075", "#808080", "#ffffff", "#000000",
];

export default function MapApp() {
  // --- AUTH STATES ---
  const [users, setUsers] = useState([]); // simple in-memory user store
  const [currentUser, setCurrentUser] = useState(null);
  const [authPage, setAuthPage] = useState("welcome"); // welcome, login, signup

  // --- FORM STATES ---
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [authError, setAuthError] = useState("");

  // --- MAP SELECTION ---
  const [mapType, setMapType] = useState("continents"); // continents or countries
  const [search, setSearch] = useState("");

  // --- MAP COLOR & STYLE ---
  const [regionColors, setRegionColors] = useState({}); // { regionId: color }
  const [borderColor, setBorderColor] = useState("#000000");
  const [backgroundColor, setBackgroundColor] = useState("#ffffff");
  const [legendEnabled, setLegendEnabled] = useState(false);

  // --- ZOOM & PAN ---
  const [zoom, setZoom] = useState(1);
  const [offset, setOffset] = useState({ x: 0, y: 0 });
  const isPanning = useRef(false);
  const panStart = useRef({ x: 0, y: 0 });
  const offsetStart = useRef({ x: 0, y: 0 });

  // --- BACKGROUND IMAGE ---
  const [bgImage, setBgImage] = useState(null);

  // --- REF TO SVG FOR EXPORT ---
  const svgRef = useRef(null);

  // -------------- AUTH HANDLERS -----------------

  function handleSignup() {
    if (!username || !password) {
      setAuthError("Please enter username and password");
      return;
    }
    if (users.find(u => u.username === username)) {
      setAuthError("Username already taken");
      return;
    }
    const newUser = { username, password };
    setUsers(prev => [...prev, newUser]);
    setCurrentUser(newUser);
    setAuthPage("map");
    setAuthError("");
  }

  function handleLogin() {
    const user = users.find(u => u.username === username && u.password === password);
    if (!user) {
      setAuthError("Invalid username or password");
      return;
    }
    setCurrentUser(user);
    setAuthPage("map");
    setAuthError("");
  }

  function logout() {
    setCurrentUser(null);
    setAuthPage("welcome");
    setUsername("");
    setPassword("");
    setRegionColors({});
    setBorderColor("#000000");
    setBackgroundColor("#ffffff");
    setLegendEnabled(false);
    setZoom(1);
    setOffset({ x: 0, y: 0 });
    setBgImage(null);
  }

  // ----------- MAP INTERACTION -------------------

  const mapRegions = MAPS[mapType].filter(region =>
    region.name.toLowerCase().includes(search.toLowerCase())
  );

  function handleRegionClick(id) {
    // Cycle color or set to first color
    const current = regionColors[id];
    const currentIndex = COLORS.indexOf(current);
    const nextIndex = currentIndex === -1 || currentIndex === COLORS.length - 1 ? 0 : currentIndex + 1;
    setRegionColors(prev => ({ ...prev, [id]: COLORS[nextIndex] }));
  }

  // ----------- ZOOM AND PAN -----------------------

  function handleWheel(e) {
    e.preventDefault();
    const delta = e.deltaY;
    setZoom(z => {
      let nextZoom = z - delta * 0.001;
      if (nextZoom < 0.5) nextZoom = 0.5;
      if (nextZoom > 5) nextZoom = 5;
      return nextZoom;
    });
  }

  function handleMouseDown(e) {
    isPanning.current = true;
    panStart.current = { x: e.clientX, y: e.clientY };
    offsetStart.current = { ...offset };
  }

  function handleMouseMove(e) {
    if (!isPanning.current) return;
    const dx = e.clientX - panStart.current.x;
    const dy = e.clientY - panStart.current.y;
    setOffset({ x: offsetStart.current.x + dx, y: offsetStart.current.y + dy });
  }

  function handleMouseUp() {
    isPanning.current = false;
  }

  // ------------ EXPORT TO PNG -------------------

  async function saveAsPNG() {
    if (!svgRef.current) return;

    const svgElement = svgRef.current;
    const svgData = new XMLSerializer().serializeToString(svgElement);
    const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);

    const image = new Image();
    image.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = image.width * 2;
      canvas.height = image.height * 2;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

      if (legendEnabled) {
        // Draw legend
        const legendX = 20;
        const legendY = 20;
        ctx.font = "16px Arial";
        ctx.fillStyle = "#000";
        ctx.fillText("Legend:", legendX, legendY);

        Object.entries(regionColors).forEach(([regionId, color], i) => {
          ctx.fillStyle = color;
          ctx.fillRect(legendX, legendY + 10 + 20 * (i + 1), 18, 18);
          ctx.fillStyle = "#000";
          ctx.fillText(regionId, legendX + 25, legendY + 25 + 20 * i);
        });
      }

      const pngUrl = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = pngUrl;
      a.download = "map.png";
      a.click();

      URL.revokeObjectURL(url);
    };
    image.onerror = () => alert("Error exporting image");
    image.src = url;
  }

  // ------------ BACKGROUND IMAGE UPLOAD --------------

  function handleBgImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => setBgImage(reader.result);
    reader.readAsDataURL(file);
  }

  // ----------------- JSX -------------------------------------

  if (authPage !== "map") {
    // AUTH UI
    return (
      <div style={styles.app}>
        <h1 style={styles.title}>Welcome to Map Designer</h1>

        {authPage === "welcome" && (
          <>
            <button
              style={styles.button}
              onClick={() => setAuthPage("login")}
            >
              Login
            </button>
            <button
              style={{ ...styles.button, marginLeft: 20 }}
              onClick={() => setAuthPage("signup")}
            >
              Create Account
            </button>
          </>
        )}

        {(authPage === "login" || authPage === "signup") && (
          <div style={styles.form}>
            <input
              style={styles.input}
              placeholder="Username"
              value={username}
              onChange={e => setUsername(e.target.value)}
            />
            <input
              style={styles.input}
              placeholder="Password"
              type="password"
              value={password}
              onChange={e => setPassword(e.target.value)}
            />
            {authError && <p style={styles.error}>{authError}</p>}

            {authPage === "login" && (
              <>
                <button style={styles.button} onClick={handleLogin}>Login</button>
                <button style={styles.linkButton} onClick={() => setAuthPage("welcome")}>Back</button>
              </>
            )}

            {authPage === "signup" && (
              <>
                <button style={styles.button} onClick={handleSignup}>Create Account</button>
                <button style={styles.linkButton} onClick={() => setAuthPage("welcome")}>Back</button>
              </>
            )}
          </div>
        )}
      </div>
    );
  }

  // MAP DESIGNER UI
  return (
    <div style={styles.app}>
      <header style={styles.header}>
        <h2>Welcome, {currentUser.username}!</h2>
        <button style={styles.logoutBtn} onClick={logout}>Logout</button>
      </header>

      {/* Map Type Selector */}
      <section style={styles.controlsSection}>
        <div>
          <label>
            <input
              type="radio"
              name="mapType"
              checked={mapType === "continents"}
              onChange={() => setMapType("continents")}
            />
            Continents
          </label>
          <label style={{ marginLeft: 20 }}>
            <input
              type="radio"
              name="mapType"
              checked={mapType === "countries"}
              onChange={() => setMapType("countries")}
            />
            Countries
          </label>
        </div>

        {/* Search */}
        <input
          type="text"
          placeholder="Search region..."
          value={search}
          onChange={e => setSearch(e.target.value)}
          style={styles.searchInput}
        />
      </section>

      {/* Map SVG Container */}
      <section
        style={{
          ...styles.mapContainer,
          backgroundColor,
          backgroundImage: bgImage ? `url(${bgImage})` : "none",
          backgroundSize: "cover",
          backgroundPosition: "center",
        }}
        onWheel={handleWheel}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
      >
        <svg
          ref={svgRef}
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 100 100"
          style={{
            cursor: isPanning.current ? "grabbing" : "grab",
            transform: `translate(${offset.x}px, ${offset.y}px) scale(${zoom})`,
            transition: "transform 0.1s",
            width: "100%",
            height: "100%",
          }}
        >
          {mapRegions.map(region => (
            <path
              key={region.id}
              d={region.path}
              fill={regionColors[region.id] || "#ccc"}
              stroke={borderColor}
              strokeWidth="1"
              onClick={() => handleRegionClick(region.id)}
              style={{ cursor: "pointer", transition: "fill 0.3s" }}
              title={region.name}
            />
          ))}
        </svg>
      </section>

      {/* Controls Panel */}
      <section style={styles.controlsSection}>
        <div>
          <label>Border Color:</label>
          <input
            type="color"
            value={borderColor}
            onChange={e => setBorderColor(e.target.value)}
            style={{ marginLeft: 10 }}
          />
        </div>

        <div>
          <label>Background Color:</label>
          <input
            type="color"
            value={backgroundColor}
            onChange={e => setBackgroundColor(e.target.value)}
            style={{ marginLeft: 10 }}
          />
        </div>

        <div>
          <label>Add Background Image:</label>
          <input
            type="file"
            accept="image/*"
            onChange={handleBgImageUpload}
            style={{ marginLeft: 10 }}
          />
          {bgImage && (
            <button
              style={{ marginLeft: 10 }}
              onClick={() => setBgImage(null)}
              title="Remove background image"
            >
              Remove Image
            </button>
          )}
        </div>

        <div>
          <label>
            <input
              type="checkbox"
              checked={legendEnabled}
              onChange={e => setLegendEnabled(e.target.checked)}
            />
            Show Legend
          </label>
        </div>

        {/* Color palette for regions */}
        <div style={{ marginTop: 10 }}>
          <label>Click region on map to cycle colors. Palette:</label>
          <div style={styles.palette}>
            {COLORS.map(c => (
              <div
                key={c}
                style={{
                  backgroundColor: c,
                  width: 24,
                  height: 24,
                  borderRadius: 4,
                  marginRight: 8,
                  border: "1px solid #ccc",
                  display: "inline-block",
                }}
                title={c}
              />
            ))}
          </div>
        </div>

        {/* Zoom controls */}
        <div style={{ marginTop: 10 }}>
          <button onClick={() => setZoom(z => Math.min(5, z + 0.2))}>Zoom In +</button>
          <button onClick={() => setZoom(z => Math.max(0.5, z - 0.2))} style={{ marginLeft: 10 }}>Zoom Out -</button>
          <button onClick={() => { setZoom(1); setOffset({ x: 0, y: 0 }); }} style={{ marginLeft: 10 }}>
            Reset View
          </button>
        </div>

        {/* Save button */}
        <div style={{ marginTop: 20 }}>
          <button onClick={saveAsPNG} style={styles.saveButton}>Save Map as PNG</button>
        </div>
      </section>

      {/* Legend Display */}
      {legendEnabled && (
        <section style={styles.legend}>
          <h4>Legend</h4>
          <ul style={{ listStyle: "none", padding: 0 }}>
            {Object.entries(regionColors).map(([regionId, color]) => (
              <li key={regionId} style={{ marginBottom: 6 }}>
                <span
                  style={{
                    display: "inline-block",
                    width: 18,
                    height: 18,
                    backgroundColor: color,
                    marginRight: 10,
                    border: "1px solid #000",
                  }}
                />
                {regionId}
              </li>
            ))}
          </ul>
        </section>
      )}
    </div>
  );
}

const styles = {
  app: {
    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
    maxWidth: 1200,
    margin: "auto",
    padding: 20,
  },
  title: {
    fontSize: 36,
    marginBottom: 30,
    textAlign: "center",
  },
  button: {
    backgroundColor: "#4363d8",
    color: "white",
    padding: "10px 20px",
    border: "none",
    borderRadius: 6,
    cursor: "pointer",
    fontSize: 16,
  },
  logoutBtn: {
    backgroundColor: "#d9534f",
    border: "none",
    borderRadius: 6,
    padding: "6px 14px",
    cursor: "pointer",
    color: "#fff",
    fontWeight: "bold",
  },
  linkButton: {
    background: "none",
    border: "none",
    color: "#4363d8",
    cursor: "pointer",
    marginLeft: 10,
    fontSize: 14,
  },
  form: {
    display: "flex",
    flexDirection: "column",
    maxWidth: 320,
    margin: "auto",
  },
  input: {
    fontSize: 16,
    padding: 10,
    marginBottom: 10,
    borderRadius: 6,
    border: "1px solid #ccc",
  },
  error: {
    color: "red",
    marginBottom: 10,
  },
  header: {
    display: "flex",
    justifyContent: "space-between",
    alignItems: "center",
    marginBottom: 15,
  },
  controlsSection: {
    marginBottom: 20,
    display: "flex",
    alignItems: "center",
    flexWrap: "wrap",
    gap: 20,
  },
  searchInput: {
    padding: 8,
    fontSize: 16,
    borderRadius: 6,
    border: "1px solid #ccc",
    minWidth: 220,
  },
  mapContainer: {
    border: "2px solid #ddd",
    borderRadius: 12,
    height: 400,
    overflow: "hidden",
    marginBottom: 20,
    userSelect: "none",
  },
  palette: {
    display: "flex",
    flexWrap: "wrap",
    maxWidth: 360,
    marginTop: 8,
  },
  saveButton: {
    backgroundColor: "#28a745",
    color: "white",
    border: "none",
    padding: "10px 24px",
    borderRadius: 6,
    fontSize: 16,
    cursor: "pointer",
  },
  legend: {
    backgroundColor: "#f9f9f9",
    border: "1px solid #ccc",
    borderRadius: 6,
    padding: 16,
    maxWidth: 300,
  },
};

