<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geomarkr - Map Editor</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#111; color:#eee;}
  #map { width: 100%; height: 600px; }
  .country {
    stroke: #333;
    stroke-width: 0.5;
    cursor: pointer;
  }
  .country:hover {
    stroke: #fff;
    stroke-width: 1.5;
  }
  #color-palette button {
    width: 30px; height: 30px; margin: 3px; border: none; cursor: pointer;
  }
  #controls {
    padding: 10px;
    background: #222;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  #search {
    padding: 6px;
    font-size: 16px;
    border-radius: 4px;
    border: none;
    flex-grow: 1;
  }
  button {
    background: #06f;
    border: none;
    padding: 8px 14px;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #0053ba;
  }
</style>
</head>
<body>

<div id="controls">
  <input id="search" placeholder="Search countries..." />
  <div id="color-palette"></div>
  <button id="export-btn">Export PNG</button>
</div>
<div id="map"></div>

<script>
(async function(){
  const width = document.getElementById('map').clientWidth;
  const height = 600;

  const svg = d3.select('#map').append('svg')
    .attr('width', width)
    .attr('height', height);

  // Color palette
  const colors = [
    "#d73027","#f46d43","#fdae61","#fee08b","#d9ef8b",
    "#a6d96a","#66bd63","#1a9850","#006837","#004529",
    "#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494",
    "#081d58","#ffffb2","#fecc5c","#fd8d3c","#f03b20"
  ];

  // Add buttons for colors
  const palette = d3.select('#color-palette');
  let selectedColor = colors[0];

  colors.forEach(c => {
    palette.append('button')
      .style('background-color', c)
      .on('click', () => {
        selectedColor = c;
      });
  });

  // Projection and path
  const projection = d3.geoMercator()
    .scale(150)
    .translate([width / 2, height / 1.5]);
  const path = d3.geoPath().projection(projection);

  // Load world topojson
  const worldData = await d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');

  const countries = topojson.feature(worldData, worldData.objects.countries).features;

  // Draw countries
  const countryPaths = svg.selectAll('path')
    .data(countries)
    .join('path')
    .attr('class', 'country')
    .attr('d', path)
    .attr('fill', '#444')
    .on('click', (event, d) => {
      const currentColor = d3.select(event.currentTarget).attr('fill');
      d3.select(event.currentTarget).attr('fill', currentColor === selectedColor ? '#444' : selectedColor);
    });

  // Search functionality
  const searchInput = document.getElementById('search');
  searchInput.addEventListener('input', () => {
    const val = searchInput.value.toLowerCase();
    countryPaths.attr('opacity', d => {
      const name = d.properties ? d.properties.name : '';
      return name && name.toLowerCase().includes(val) ? 1 : 0.2;
    });
  });

  // Export PNG
  document.getElementById('export-btn').addEventListener('click', () => {
    const svgElement = svg.node();
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgElement);

    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');

    const img = new Image();
    const svgBlob = new Blob([svgString], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);

    img.onload = function(){
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(url);
      const pngUrl = canvas.toDataURL("image/png");
      const link = document.createElement('a');
      link.href = pngUrl;
      link.download = 'map.png';
      link.click();
    };

    img.src = url;
  });

})();
</script>

</body>
</html>

