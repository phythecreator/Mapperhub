<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Image Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .gradient-border {
            position: relative;
            border-radius: 1rem;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            padding: 1px;
        }
        .gradient-border > div {
            background: #0f172a;
            border-radius: calc(1rem - 1px);
        }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .aspect-option input:checked + label {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <div class="max-w-5xl mx-auto px-4 pt-12">
        <!-- Header -->
        <header class="flex flex-col items-center mb-12 text-center">
            <div class="inline-block px-4 py-1.5 mb-4 text-xs font-bold tracking-widest text-blue-400 uppercase bg-blue-400/10 rounded-full">
                Nova Geração v2.0
            </div>
            <h1 class="text-5xl font-extrabold mb-4 tracking-tight">IA Image <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-violet-400">Studio Pro</span></h1>
            <p class="text-slate-400 max-w-lg">Transforma as tuas palavras em arte visual de alta fidelidade com moderação inteligente de conteúdo.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Sidebar / Controlos -->
            <aside class="lg:col-span-4 space-y-6">
                <section class="glass-card rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        Configurações
                    </h2>
                    
                    <!-- Aspect Ratio -->
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Formato da Imagem</label>
                        <div class="grid grid-cols-3 gap-2 aspect-option">
                            <input type="radio" name="ratio" id="r-sq" value="1:1" class="hidden" checked>
                            <label for="r-sq" class="flex flex-col items-center justify-center p-3 border border-slate-700 rounded-lg cursor-pointer hover:bg-slate-800 transition-colors">
                                <div class="w-4 h-4 border-2 border-current mb-1"></div>
                                <span class="text-[10px]">1:1</span>
                            </label>

                            <input type="radio" name="ratio" id="r-wd" value="16:9" class="hidden">
                            <label for="r-wd" class="flex flex-col items-center justify-center p-3 border border-slate-700 rounded-lg cursor-pointer hover:bg-slate-800 transition-colors">
                                <div class="w-6 h-3 border-2 border-current mb-1"></div>
                                <span class="text-[10px]">16:9</span>
                            </label>

                            <input type="radio" name="ratio" id="r-pt" value="9:16" class="hidden">
                            <label for="r-pt" class="flex flex-col items-center justify-center p-3 border border-slate-700 rounded-lg cursor-pointer hover:bg-slate-800 transition-colors">
                                <div class="w-3 h-6 border-2 border-current mb-1"></div>
                                <span class="text-[10px]">9:16</span>
                            </label>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-800">
                        <p class="text-[11px] text-slate-500 italic">
                            Nota: O sistema bloqueia automaticamente termos ofensivos, violentos ou inapropriados para garantir a segurança.
                        </p>
                    </div>
                </section>
                
                <!-- Histórico Mobile-friendly -->
                <section id="history-section" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider text-slate-400">Histórico</h2>
                        <button onclick="clearHistory()" class="text-[10px] text-red-400 hover:underline">Limpar</button>
                    </div>
                    <div id="history-grid" class="grid grid-cols-3 gap-2"></div>
                </section>
            </aside>

            <!-- Área de Geração -->
            <main class="lg:col-span-8 space-y-6">
                <section class="gradient-border">
                    <div class="p-6">
                        <div class="flex flex-col gap-4">
                            <div class="relative">
                                <textarea 
                                    id="prompt" 
                                    rows="4" 
                                    class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl p-4 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-lg"
                                    placeholder="Descreve a tua visão... ex: Um gato samurai no topo de um arranha-céus futurista"
                                ></textarea>
                                <div id="char-count" class="absolute bottom-3 right-3 text-[10px] text-slate-500">0 / 500</div>
                            </div>
                            
                            <button 
                                onclick="handleGenerate()" 
                                id="generate-btn"
                                class="w-full bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-500 hover:to-violet-500 text-white font-bold py-5 rounded-xl transition-all flex items-center justify-center gap-3 shadow-xl active:scale-[0.99] disabled:opacity-50"
                            >
                                <span id="btn-text">Gerar Obra de Arte</span>
                                <div id="btn-loader" class="loader hidden"></div>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Área de Resultado Principal -->
                <section id="result-section" class="hidden animate-in zoom-in duration-300">
                    <div class="glass-card rounded-2xl overflow-hidden shadow-2xl">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                            <div class="flex gap-2">
                                <span class="inline-block w-3 h-3 rounded-full bg-red-500/50"></span>
                                <span class="inline-block w-3 h-3 rounded-full bg-yellow-500/50"></span>
                                <span class="inline-block w-3 h-3 rounded-full bg-green-500/50"></span>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="downloadImage()" class="flex items-center gap-2 text-xs font-bold text-blue-400 hover:text-blue-300 uppercase tracking-tighter transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                    Guardar
                                </button>
                            </div>
                        </div>
                        <div class="relative bg-black flex items-center justify-center min-h-[400px]">
                            <img id="output-image" src="" alt="Gerado pela IA" class="max-w-full h-auto shadow-2xl">
                        </div>
                        <div class="p-4 bg-slate-900/50">
                            <p id="display-prompt" class="text-sm text-slate-300 italic text-center"></p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modais e Notificações -->
    <div id="toast" class="fixed bottom-8 right-8 max-w-md w-full bg-slate-900 border border-slate-700 p-4 rounded-xl shadow-2xl transform translate-y-20 transition-transform duration-300 flex items-start gap-3 z-50">
        <div id="toast-icon" class="p-2 rounded-lg bg-red-500/20 text-red-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        </div>
        <div class="flex-1">
            <h4 id="toast-title" class="font-bold text-sm">Erro de Moderação</h4>
            <p id="toast-msg" class="text-xs text-slate-400 mt-1"></p>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let currentImageUrl = "";
        let history = JSON.parse(localStorage.getItem('ai_img_v2_history') || '[]');

        // Lista de termos proibidos (simplificada para demonstração)
        // No mundo real, usaríamos a própria API ou uma lista exaustiva
        const forbiddenTerms = [
            'nudez', 'sexo', 'porno', 'gore', 'sangue', 'morte', 'violencia', 
            'racismo', 'hitler', 'suicidio', 'terrorismo', 'bomba', 'drogas',
            'assassinato', 'vulgar', 'obscene', 'sexual', 'naked'
        ];

        window.onload = () => {
            renderHistory();
            document.getElementById('prompt').addEventListener('input', (e) => {
                document.getElementById('char-count').innerText = `${e.target.value.length} / 500`;
            });
        };

        function checkContent(text) {
            const lowerText = text.toLowerCase();
            return forbiddenTerms.some(term => lowerText.includes(term));
        }

        async function handleGenerate() {
            const promptInput = document.getElementById('prompt');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                showToast("Aviso", "Por favor, escreve algo antes de gerar.", "warning");
                return;
            }

            if (checkContent(prompt)) {
                showToast("Conteúdo Restrito", "A tua descrição contém palavras que violam as nossas diretrizes de segurança. Por favor, altera o texto.", "error");
                return;
            }

            await generateImage(prompt);
        }

        async function generateImage(prompt) {
            const btn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const resultSection = document.getElementById('result-section');
            const outputImg = document.getElementById('output-image');
            
            // Get selected aspect ratio (though Imagen 4 might handle it via prompt)
            const ratio = document.querySelector('input[name="ratio"]:checked').value;
            const enhancedPrompt = `${prompt}, aspect ratio ${ratio}, highly detailed, professional lighting`;

            btn.disabled = true;
            btnText.innerText = "A Imaginar...";
            btnLoader.classList.remove('hidden');

            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        instances: [{ prompt: enhancedPrompt }],
                        parameters: { sampleCount: 1 }
                    })
                });

                const result = await response.json();
                
                if (result.predictions && result.predictions[0]) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    currentImageUrl = `data:image/png;base64,${base64Data}`;
                    
                    outputImg.src = currentImageUrl;
                    document.getElementById('display-prompt').innerText = prompt;
                    resultSection.classList.remove('hidden');
                    
                    addToHistory(currentImageUrl, prompt);
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'end' });
                } else {
                    throw new Error("API Limit reached or Safety block");
                }

            } catch (error) {
                console.error(error);
                showToast("Falha técnica", "O servidor de IA está ocupado ou bloqueou o pedido por segurança. Tenta algo diferente.", "error");
            } finally {
                btn.disabled = false;
                btnText.innerText = "Gerar Obra de Arte";
                btnLoader.classList.add('hidden');
            }
        }

        async function fetchWithRetry(url, options, retries = 5) {
            let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status !== 429 && response.status < 500) break;
                } catch (e) {}
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            throw new Error("Erro persistente na ligação");
        }

        function showToast(title, msg, type) {
            const toast = document.getElementById('toast');
            const tTitle = document.getElementById('toast-title');
            const tMsg = document.getElementById('toast-msg');
            const tIcon = document.getElementById('toast-icon');

            tTitle.innerText = title;
            tMsg.innerText = msg;

            if (type === 'error') {
                tIcon.className = "p-2 rounded-lg bg-red-500/20 text-red-500";
            } else if (type === 'warning') {
                tIcon.className = "p-2 rounded-lg bg-yellow-500/20 text-yellow-500";
            }

            toast.classList.remove('translate-y-20');
            toast.classList.add('translate-y-0');

            setTimeout(() => {
                toast.classList.remove('translate-y-0');
                toast.classList.add('translate-y-20');
            }, 5000);
        }

        function downloadImage() {
            if (!currentImageUrl) return;
            const link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = `ia-studio-pro-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function addToHistory(url, prompt) {
            const item = { url, prompt, id: Date.now() };
            history.unshift(item);
            if (history.length > 12) history.pop();
            localStorage.setItem('ai_img_v2_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('history-section');
            const grid = document.getElementById('history-grid');
            
            if (history.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            grid.innerHTML = history.map(item => `
                <div class="group relative aspect-square rounded-lg overflow-hidden cursor-pointer border border-white/5 bg-slate-800" onclick="selectFromHistory('${item.id}')">
                    <img src="${item.url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" alt="Histórico">
                    <div class="absolute inset-0 bg-blue-600/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M5 12l5 5L20 7"/></svg>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm("Tens a certeza que queres limpar todo o histórico?")) {
                history = [];
                localStorage.removeItem('ai_img_v2_history');
                renderHistory();
            }
        }

        function selectFromHistory(id) {
            const item = history.find(h => h.id == id);
            if (item) {
                currentImageUrl = item.url;
                document.getElementById('output-image').src = item.url;
                document.getElementById('prompt').value = item.prompt;
                document.getElementById('display-prompt').innerText = item.prompt;
                document.getElementById('result-section').classList.remove('hidden');
                window.scrollTo({ top: 300, behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>
